<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Реалізація обміну повідомленнями за допомогою RabbitMQ | Розподілені інформаційні системи</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/docs/faviconCustom.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="description" content="Курс лекцій">
    
    <link rel="preload" href="/docs/assets/css/0.styles.f5591410.css" as="style"><link rel="preload" href="/docs/assets/js/app.6573e971.js" as="script"><link rel="preload" href="/docs/assets/js/2.43c74522.js" as="script"><link rel="preload" href="/docs/assets/js/29.0d739a8d.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.ae09fb39.js"><link rel="prefetch" href="/docs/assets/js/11.a892532e.js"><link rel="prefetch" href="/docs/assets/js/12.502d8f9b.js"><link rel="prefetch" href="/docs/assets/js/13.19ba463b.js"><link rel="prefetch" href="/docs/assets/js/14.b9bc508f.js"><link rel="prefetch" href="/docs/assets/js/15.8378044f.js"><link rel="prefetch" href="/docs/assets/js/16.c5ab21e3.js"><link rel="prefetch" href="/docs/assets/js/17.056e16ea.js"><link rel="prefetch" href="/docs/assets/js/18.d77e96ca.js"><link rel="prefetch" href="/docs/assets/js/19.b664be5a.js"><link rel="prefetch" href="/docs/assets/js/20.d99a3a28.js"><link rel="prefetch" href="/docs/assets/js/21.19f4d8a1.js"><link rel="prefetch" href="/docs/assets/js/22.c12e4cd6.js"><link rel="prefetch" href="/docs/assets/js/23.cea9fca9.js"><link rel="prefetch" href="/docs/assets/js/24.03b428d0.js"><link rel="prefetch" href="/docs/assets/js/25.1189308b.js"><link rel="prefetch" href="/docs/assets/js/26.73a0e546.js"><link rel="prefetch" href="/docs/assets/js/27.94f39345.js"><link rel="prefetch" href="/docs/assets/js/28.a6b74891.js"><link rel="prefetch" href="/docs/assets/js/3.418ab320.js"><link rel="prefetch" href="/docs/assets/js/30.d3e49c4f.js"><link rel="prefetch" href="/docs/assets/js/31.5a79ea41.js"><link rel="prefetch" href="/docs/assets/js/32.892f4cee.js"><link rel="prefetch" href="/docs/assets/js/33.43c31432.js"><link rel="prefetch" href="/docs/assets/js/34.aa8b7542.js"><link rel="prefetch" href="/docs/assets/js/35.106db34a.js"><link rel="prefetch" href="/docs/assets/js/36.decaa943.js"><link rel="prefetch" href="/docs/assets/js/37.35adf566.js"><link rel="prefetch" href="/docs/assets/js/38.b395a8e9.js"><link rel="prefetch" href="/docs/assets/js/4.f33b38e3.js"><link rel="prefetch" href="/docs/assets/js/5.335a55c0.js"><link rel="prefetch" href="/docs/assets/js/6.98f769b8.js"><link rel="prefetch" href="/docs/assets/js/7.eaf79c7b.js"><link rel="prefetch" href="/docs/assets/js/8.721b5dad.js"><link rel="prefetch" href="/docs/assets/js/9.e42fd085.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.f5591410.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">Розподілені інформаційні системи</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div> <a href="https://github.com/boldak/dis-edu" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div> <a href="https://github.com/boldak/dis-edu" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/docs/intro/" class="sidebar-heading clickable"><span>Вступ</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/arch/" class="sidebar-heading clickable"><span>Архітетура розподілених інформаційних систем</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/components-interaction/" class="sidebar-heading clickable"><span>Реалізація взаємодії компонентів розподіленої інформаційної системи</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/swagger/" class="sidebar-heading clickable"><span>Прикладний програмний інтерфейс сервісів</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/eda/" class="sidebar-heading clickable router-link-active open"><span>Реалізація взаємодії компонентів в EDA</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/eda/13.rabbitmq.html" aria-current="page" class="active sidebar-link">Реалізація обміну повідомленнями за допомогою RabbitMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/eda/13.rabbitmq.html#реалізація-простоі-взаємодіі-з-використанням-черг-повідомлень" class="sidebar-link">Реалізація простої взаємодії з використанням черг повідомлень</a></li><li class="sidebar-sub-header"><a href="/docs/eda/13.rabbitmq.html#реалізація-черги-завдань" class="sidebar-link">Реалізація черги завдань</a></li><li class="sidebar-sub-header"><a href="/docs/eda/13.rabbitmq.html#реалізація-шаблону-взаємодіі-pub-sub" class="sidebar-link">Реалізація шаблону взаємодії PUB/SUB</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/eda/13.rabbitmq.html#режим-fanout" class="sidebar-link">Режим fanout</a></li><li class="sidebar-sub-header"><a href="/docs/eda/13.rabbitmq.html#режим-direct" class="sidebar-link">Режим direct</a></li><li class="sidebar-sub-header"><a href="/docs/eda/13.rabbitmq.html#режим-topic" class="sidebar-link">Режим topic</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/eda/13.rabbitmq.html#реалізація-шаблону-rpc" class="sidebar-link">Реалізація шаблону RPC</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/msa/" class="sidebar-heading clickable"><span>Реалізація взаємодії сервісів в MSA</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="реалізація-обміну-повідомленнями-за-допомогою-rabbitmq"><a href="#реалізація-обміну-повідомленнями-за-допомогою-rabbitmq" class="header-anchor">#</a> Реалізація обміну повідомленнями за допомогою RabbitMQ</h1> <p>RabbitMQ - найпоширеніший брокер повідомлень з відкритим кодом.
З десятками тисяч користувачів, RabbitMQ є одним з найпопулярніших посередників повідомлень з відкритим кодом, який використовується у всьому світі для невеликих стартапів та великих підприємств.</p> <p>RabbitMQ є легким і простим у розгортанні. Він підтримує декілька протоколів обміну повідомленнями. RabbitMQ можна розгортати у розподілених та об’єднаних конфігураціях для задоволення масштабних вимог високої доступності.</p> <p>Для нашої реалізації скористамося хмарним сервісом <a href="https://www.cloudamqp.com/" target="_blank" rel="noopener noreferrer">CloudAMQP<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, який є SaaS та надає фунціональність брокера повідомлень з підтримкою протоколу AMQP.</p> <p>Для цього треба створити власний профіль, скориставшись власним Google Account</p> <center><img src="/13-01.jpg" style="border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);"></center> <p>Вибрати безкоштовний план</p> <center><img src="/13-02.jpg" style="border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);"></center> <p>Вибрати майданчик для розташування сервісу та створити його екземпляр. Тепер маємо доступ до брокера повідомлень, його AMQP URL ми будемо використовувати в наших програмах.</p> <center><img src="/13-03.jpg" style="border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);"></center> <p>Підготуємо проект та встановимо необхідні залежності. Файл <code>package.json</code> має наступний вигляд</p> <div class="language-json extra-class"><pre class="language-json"><code>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eda&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Event Driven Arch with RabbitMQ&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;amqplib&quot;</span><span class="token operator">:</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lodash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.17.21&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;moment&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.29.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.3.2&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Серед цих залежностей ключовою є <a href="https://www.npmjs.com/package/amqplib" target="_blank" rel="noopener noreferrer">amqplib<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, яка забезпечує взаємодію клієнтів (продюсерів та споживачів) з брокером повідомлень RabbitMQ.</p> <h2 id="реалізація-простоі-взаємодіі-з-використанням-черг-повідомлень"><a href="#реалізація-простоі-взаємодіі-з-використанням-черг-повідомлень" class="header-anchor">#</a> Реалізація простої взаємодії з використанням черг повідомлень</h2> <p>Ми напишемо дві невеликі програми на Javascript; продюсер, який надсилає одне повідомлення, і споживач, який отримує повідомлення і роздруковує їх.</p> <p>Типова схема використання виглядає наступним чином: створюємо з'єднання, потім створюємо канал, оголошуємо чергу для надсилання повідомлень; тоді ми можемо публікувати повідомлення в ній.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token operator">...</span>

   <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
   <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">PRIMARY</span><span class="token punctuation">)</span>
   
   <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">sendToQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">PRIMARY</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token operator">...</span>

</code></pre></div><p>Після окінчення взаємодії ми повинні закрити канал та з'єднання</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token operator">...</span>

   <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token operator">...</span>

</code></pre></div><p>Як бачимо більшість методів <code>connection</code>та <code>channel</code> є асинхронними.</p> <p>Створимо файл конфігурації <code>./src/config.js</code>, який містить AMQP URL та налаштування (імена) для черг та обмінників:</p> <div class="language-js extra-class"><pre class="language-js"><code>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">AMQP_CONNECTION_URL</span><span class="token operator">:</span> <span class="token string">'&lt;your AMQP URL&gt;'</span><span class="token punctuation">,</span>
    queue<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token constant">PRIMARY</span><span class="token operator">:</span> <span class="token string">'primary'</span><span class="token punctuation">,</span>
        <span class="token constant">TASK</span><span class="token operator">:</span> <span class="token string">'task_queue'</span><span class="token punctuation">,</span>
        <span class="token constant">RPC</span><span class="token operator">:</span><span class="token string">'rpc'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    exchange<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token constant">LOGS</span><span class="token operator">:</span> <span class="token string">'logs'</span><span class="token punctuation">,</span>
        <span class="token constant">DIRECT</span><span class="token operator">:</span> <span class="token string">'direct_logs'</span><span class="token punctuation">,</span>
        <span class="token constant">TOPIC</span><span class="token operator">:</span> <span class="token string">'topic_logs'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Тепер створимо файл для простого продюсера <code>./src/simple-producer</code></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token punctuation">{</span>
      at<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      text<span class="token operator">:</span> <span class="token string">&quot;Message from producer&quot;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">PRIMARY</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> assertion <span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> send <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">sendToQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">PRIMARY</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Simple Producer send message &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>Бібліотеку <a href="">moment.js</a> будемо використовувати для оформлення часових міток повідомлень. Для цього визначимо функцію <code>log</code>.</p> <p>Визначаємо асинхронну функцію <code>run</code>, яка здійснює всю небхідну роботу. Потім її викликаємо.</p> <p>Налаштування вибираємо з об'єкту конфігурації <code>config</code>. Діємо за стандартною схемою: <em><strong>з'єднання  &gt; канал &gt; черга &gt; повідомлення</strong></em>. Після відправлення повідомлення закриваємо канал та з'єднання.</p> <p>В якості повідомлення можна відправити будь-яку інформацію, проте вона повинна серіалізуватися в потік байтів. Зрозуміло, що на іншому боці (у споживача) потрібно застосувати зворотнє перетворення. Наприклад, наше повідомлення <code>message</code> є об'єктом; для його відправлення в якості повідомлення ми його серіалізуємо в рядок та перетворюємо у потік байтів</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code> 
 <span class="token operator">...</span>
 channel<span class="token punctuation">.</span><span class="token function">sendToQueue</span><span class="token punctuation">(</span>
    config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">PRIMARY</span><span class="token punctuation">,</span> 
    Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
 <span class="token operator">...</span> 


</code></pre></div><p>Створимо файл споживача повідомлень <code>./src/simple-consumer.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">PRIMARY</span><span class="token punctuation">)</span>
    
    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">PRIMARY</span><span class="token punctuation">,</span> 
        <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre></div><p>Так само, як і для продюсера, ми створюємо з'єднання, канал і чергу, проте визначаємо слухача черги, який реагує на доставлення повідомлення</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token operator">...</span> 

    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">PRIMARY</span><span class="token punctuation">,</span> 
        <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>

<span class="token operator">...</span>


</code></pre></div><p>Саме повідомлення знаходиться в <code>msg.content</code> у вигляді послідовності байтів. Ми виконуємо зворотнє перетворення до того, що виконувалося в продюсері, та відновлюємо об'єкт повідомлення.</p> <p>Для перевірки роботи обміну повідомленнями треба створити дві консолі та запустити в першій <code>node ./src/simple-producer</code>, а в другій <code>node ./src/simple-consumer</code></p> <p>Вивід в консолі продюсера</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/simple-producer                                                               
<span class="token number">2021.08</span>.23 <span class="token number">14</span>:53:03: Simple Producer send message <span class="token string">&quot;{&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T11:53:02.448Z<span class="token string">&quot;,&quot;</span>text<span class="token string">&quot;:&quot;</span>Message from producer<span class="token string">&quot;}&quot;</span>     

</code></pre></div><p>Вивід в консолі споживача</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/simple-consumer                                                               
<span class="token number">2021.08</span>.23 <span class="token number">14</span>:54:02: Received <span class="token punctuation">{</span> 
  <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T11:53:02.448Z&quot;</span>,                                                               
  <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Message from producer&quot;</span>                                                                   
<span class="token punctuation">}</span>                     


</code></pre></div><p>Слід зауважити, що крім <code>msg.content</code> у повідомленні можна передати додаткові властивості, доступ до яких здійснюється через
<code>msg.properties</code>. Одним з таких є <code>msg.properties.contentType</code>, що містить MIME-тип повідомлення. Ця властивість використовується продюсерами, щоб повідомити споживачів, яким чином вони можуть десеріалізувати повідомлення. Сам брокер та клієнтська бібліотека не обробляють ці властивості ніяк. Тобто, при надсиланні повідомлення слід його перетворювати в послідовність байтів незалежно від встановленого <code>msg.properties.contentType</code>. При отриманні повідомлення можна спиратися на значення <code>msg.properties.contentType</code> для вірної десеріалізації повідомлення.</p> <p>Таким чином, використовуючи спільну чергу, ми реалізували взаємодію продюсера та споживача за допомогою обміну повідомленнями.</p> <h2 id="реалізація-черги-завдань"><a href="#реалізація-черги-завдань" class="header-anchor">#</a> Реалізація черги завдань</h2> <p>Основна ідея робочих черги завдань полягає у тому, щоб уникнути негайного виконання ресурсомісткого завдання і не чекати його завершення. Натомість ми плануємо виконання завдання пізніше. Ми інкапсулюємо завдання як повідомлення і надсилаємо його до черги. Робочий процес, що працює у фоновому режимі, викличе завдання та врешті-решт виконає його. Коли ви керуєте багатьма працівниками, завдання будуть розподілені між ними.</p> <center style="border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);padding:1em;"><img src="https://www.plantuml.com/plantuml/svg/RP2x3e9044Nx-Oh9zX1tIq88qSBAWaX2WSsA4oNYWliWVhw31OhQpUEUEu_SUMrzk7K00mTjqmxQU2otg1sAFTcnRKW07Fi7YXqvfy-4QzjVoGfS8iKBARMxOX4eqC6awUQYZQ4komIGEI6xm79G9TzKrLksHIcM2lMZKBnG7MNJbWbQkWTo7YLmEXMB1Fqabb2dKSIY1Fb87nogrUgNKz-S-ii1tyUgIixkkl7jg3rnRUwgsGC--fp5SGoGym_urKy0" alt="uml diagram"></center> <p>Ця концепція особливо корисна у веб-додатках, де неможливо виконати складне завдання під час короткого вікна запиту HTTP.</p> <p>Створимо файл <code>./src/task-generator.js</code>, який імітує отримання потоку запитів та генерацію потоку завдань</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">TASK</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> assertion <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token punctuation">{</span>
                name<span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Task </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                at<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                duration<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">let</span> send <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">sendToQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">TASK</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Send task &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>   
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre></div><p>Після створення черги генератор завдань генерує 10 завдань з випадковим часом виконання та передає їх в чергу. Після чого закриває канал та з'єднання.</p> <p>Створимо файл <code>./src/task-worker.js</code> для працівника, що вирішує завдання</p> <div class="language-js extra-class"><pre class="language-js"><code>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">TASK</span><span class="token punctuation">)</span>

    
    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">TASK</span><span class="token punctuation">,</span> 
        <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Complete task &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                channel<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>duration<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>Обробник повідомлень здійснює затримку <code>task.duration</code> та повідомляє про завершення завдання. Після чого підтверджує отримання повідомлення: <code>channel.ack(msg)</code>, яке ініціює видалення його з черги завдань. Для використання можливості отримання повідомлень з підтвердженням у виклику <code>channel.consume</code> треба передати налаштування <code>{ noAck: false }</code>.</p> <p>Виконання завдання може зайняти кілька секунд. Що станеться, якщо один із споживачів розпочне довге завдання і помре, виконавши його лише частково? Як тільки RabbitMQ доставляє повідомлення споживачеві при <code>{ noAck: true }</code>, він негайно позначає його для видалення. Тобто, якщо ви вб'єте працівника, ми втратимо повідомлення, яке він обробляє. Ми також втратимо всі повідомлення, які були надіслані цьому конкретному працівнику, але ще не були оброблені.</p> <p>Щоб переконатися, що повідомлення ніколи не втрачається, RabbitMQ підтримує підтвердження повідомлень. Споживач надсилає ack, щоб повідомити RabbitMQ про те, що певне повідомлення було отримано, оброблено і що RabbitMQ може його видалити.</p> <p>Якщо споживач помирає (його канал закрито, з'єднання закрито або з'єднання TCP втрачено) без надсилання ack, RabbitMQ знову поставить його в чергу. Якщо в цей час є інші споживачі, RabbitMQ передасть ці повідомлення іншому споживачеві. Таким чином ви можете бути впевнені, що жодне повідомлення не пропаде, навіть якщо працівники час від часу вмирають.</p> <p>Будемо використовувати 3 консолі: одну - для генератора завдань, дві інші для працівників.</p> <p>Спочатку запустимо одного працівника <code>node ./src/task-worker</code> , потім - генератор завдань <code>node ./src/task-generator</code></p> <p>В консолі генератора завдань маємо</p> <div class="language-bash extra-class"><pre class="language-bash"><code>

D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/task-generator
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Send task <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">0</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T13:48:01.030Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:691}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Send task <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">1</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T13:48:01.036Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:335}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Send task <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">2</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T13:48:01.037Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:597}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Send task <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">3</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T13:48:01.038Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:625}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Send task <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">4</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T13:48:01.038Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:950}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Send task <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">5</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T13:48:01.039Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:62}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Send task <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">6</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T13:48:01.039Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:947}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Send task <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">7</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T13:48:01.040Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:334}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Send task <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">8</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T13:48:01.040Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:205}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Send task <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">9</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T13:48:01.040Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:273}&quot;</span>


</code></pre></div><p>Консоль працівника виглядає наступним чином</p> <div class="language-bash extra-class"><pre class="language-bash"><code>D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/task-worker                                                                   
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Received <span class="token punctuation">{</span>                                      
 <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Task 0&quot;</span>,                                                                                  
 <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T13:48:01.030Z&quot;</span>,                                                               
 <span class="token string">&quot;duration&quot;</span><span class="token builtin class-name">:</span> <span class="token number">691</span>                                                                                 
<span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Received <span class="token punctuation">{</span>                                                                    
 <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Task 1&quot;</span>,                                                                                  
 <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T13:48:01.036Z&quot;</span>,                                                               
 <span class="token string">&quot;duration&quot;</span><span class="token builtin class-name">:</span> <span class="token number">335</span>                                                                                 
<span class="token punctuation">}</span> 
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Received <span class="token punctuation">{</span>                                                                    
 <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Task 2&quot;</span>,                                                                                  
 <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T13:48:01.037Z&quot;</span>,                                                               
 <span class="token string">&quot;duration&quot;</span><span class="token builtin class-name">:</span> <span class="token number">597</span>                                                                                 
<span class="token punctuation">}</span> 
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Received <span class="token punctuation">{</span>                                                                    
 <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Task 3&quot;</span>,                                                                                  
 <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T13:48:01.038Z&quot;</span>,                                                               
 <span class="token string">&quot;duration&quot;</span><span class="token builtin class-name">:</span> <span class="token number">625</span>                                                                                 
<span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Received <span class="token punctuation">{</span>                                                                    
 <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Task 4&quot;</span>,                                                                                  
 <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T13:48:01.038Z&quot;</span>,                                                               
 <span class="token string">&quot;duration&quot;</span><span class="token builtin class-name">:</span> <span class="token number">950</span>                                                                                 
<span class="token punctuation">}</span> 
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Received <span class="token punctuation">{</span>                                                                    
 <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Task 5&quot;</span>,                                                                                  
 <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T13:48:01.039Z&quot;</span>,                                                               
 <span class="token string">&quot;duration&quot;</span><span class="token builtin class-name">:</span> <span class="token number">62</span>                                                                                  
<span class="token punctuation">}</span> 
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Complete task <span class="token string">&quot;Task 5&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Received <span class="token punctuation">{</span>                                                        
 <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Task 6&quot;</span>,                                                                                  
 <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T13:48:01.039Z&quot;</span>,                                                               
 <span class="token string">&quot;duration&quot;</span><span class="token builtin class-name">:</span> <span class="token number">947</span>                                                                                 
<span class="token punctuation">}</span> 
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Received <span class="token punctuation">{</span>                                                                    
 <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Task 7&quot;</span>,                                                                                  
 <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T13:48:01.040Z&quot;</span>,                                                               
 <span class="token string">&quot;duration&quot;</span><span class="token builtin class-name">:</span> <span class="token number">334</span>                                                                                 
<span class="token punctuation">}</span> 
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Received <span class="token punctuation">{</span>                                                                    
 <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Task 8&quot;</span>,                                                                                  
 <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T13:48:01.040Z&quot;</span>,                                                               
 <span class="token string">&quot;duration&quot;</span><span class="token builtin class-name">:</span> <span class="token number">205</span>                                                                                 
<span class="token punctuation">}</span> 
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Received <span class="token punctuation">{</span>                                                                    
 <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Task 9&quot;</span>,                                                                                  
 <span class="token string">&quot;at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-08-23T13:48:01.040Z&quot;</span>,                                                               
 <span class="token string">&quot;duration&quot;</span><span class="token builtin class-name">:</span> <span class="token number">273</span>                                                                                 
<span class="token punctuation">}</span> 
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Complete task <span class="token string">&quot;Task 8&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Complete task <span class="token string">&quot;Task 1&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Complete task <span class="token string">&quot;Task 9&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Complete task <span class="token string">&quot;Task 7&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Complete task <span class="token string">&quot;Task 0&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Complete task <span class="token string">&quot;Task 2&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:01: Complete task <span class="token string">&quot;Task 3&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:02: Complete task <span class="token string">&quot;Task 4&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:48:02: Complete task <span class="token string">&quot;Task 6&quot;</span>

</code></pre></div><p>Як бачимо, працівник отримує одразу 10 повідомлень, після чого виконує одне за одним відповідні завдання.</p> <p>Тепер запустимо два працівника (кожний в своїй консолі) та генератор (в коді зменшимо кількість інформації, що виводиться на
консоль)</p> <p>Працівник 1:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/task-worker
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Received Task <span class="token number">0</span>                                                          
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Received Task <span class="token number">2</span>                                                          
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Received Task <span class="token number">4</span>                                                          
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Received Task <span class="token number">6</span>                                                          
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Received Task <span class="token number">8</span>                                                          
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Complete task <span class="token string">&quot;Task 4&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Complete task <span class="token string">&quot;Task 0&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Complete task <span class="token string">&quot;Task 6&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Complete task <span class="token string">&quot;Task 8&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:28: Complete task <span class="token string">&quot;Task 2&quot;</span>

</code></pre></div><p>Працівник 2:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/task-worker
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Received Task <span class="token number">1</span>                                                          
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Received Task <span class="token number">3</span>                                                          
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Received Task <span class="token number">5</span>                                                          
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Received Task <span class="token number">7</span>                                                          
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Received Task <span class="token number">9</span>                                                          
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Complete task <span class="token string">&quot;Task 7&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Complete task <span class="token string">&quot;Task 3&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:27: Complete task <span class="token string">&quot;Task 1&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:28: Complete task <span class="token string">&quot;Task 5&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">16</span>:58:28: Complete task <span class="token string">&quot;Task 9&quot;</span>

</code></pre></div><p>Як бачимо, брокер рівномірно розподіляє завдання між працівниками. Кожен з них спочатку отримує повідомлення, потім виконує завдання. Такий розподіл не враховує час виконання завдань та може призводити до дисбалансу навантаження працівників.</p> <p>Щоб вирівняти навантаження працівників треба отримувати наступне повідомлення після того, як виконане поточне. Для цього можна
використати налаштування каналу</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">TASK</span><span class="token punctuation">)</span>

    channel<span class="token punctuation">.</span><span class="token function">prefetch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">TASK</span><span class="token punctuation">,</span> 
        <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Complete task &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                channel<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>duration<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>Після перезапуску двох працівників та генератора отримаємо бажаний результат.</p> <p>Працівник 1:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/task-worker                                                                   
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:50: Received Task <span class="token number">0</span>                                 
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:51: Complete task <span class="token string">&quot;Task 0&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:51: Received Task <span class="token number">2</span>                                                   
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:52: Complete task <span class="token string">&quot;Task 2&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:52: Received Task <span class="token number">5</span>                                                   
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:52: Complete task <span class="token string">&quot;Task 5&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:52: Received Task <span class="token number">6</span>                                                   
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:53: Complete task <span class="token string">&quot;Task 6&quot;</span>

</code></pre></div><p>Працівник 2:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/task-worker
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:50: Received Task <span class="token number">1</span>                                 
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:51: Complete task <span class="token string">&quot;Task 1&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:52: Received Task <span class="token number">3</span>                                                   
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:52: Complete task <span class="token string">&quot;Task 3&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:52: Received Task <span class="token number">4</span>                                                   
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:53: Complete task <span class="token string">&quot;Task 4&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:53: Received Task <span class="token number">7</span>                                                   
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:53: Complete task <span class="token string">&quot;Task 7&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:53: Received Task <span class="token number">8</span>                                                   
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:53: Complete task <span class="token string">&quot;Task 8&quot;</span>                                            
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:53: Received Task <span class="token number">9</span>                                                   
<span class="token number">2021.08</span>.23 <span class="token number">17</span>:08:54: Complete task <span class="token string">&quot;Task 9&quot;</span>


</code></pre></div><p>Як бачимо, навіть кількість завдань, виконаних працівниками, є різною. Кожне завдання має випадковий час виконання, а вибірка наступного повідомлення відбувається тільки після виконання поточного завдання.</p> <p>Однією з переваг використання черги завдань є можливість легко паралелізувати роботу. Якщо ми накопичуємо відставання у роботі, ми можемо просто додати більше працівників і легко масштабуватись.</p> <h2 id="реалізація-шаблону-взаємодіі-pub-sub"><a href="#реалізація-шаблону-взаємодіі-pub-sub" class="header-anchor">#</a> Реалізація шаблону взаємодії PUB/SUB</h2> <p>В попередніх випадках кожне повідомлення передавалося лише одному споживачу. Шаблон PUB/SUB передбачає передачу одно й того самого повідомлення декільком споживачам.</p> <p>Основна ідея моделі обміну повідомленнями в RabbitMQ полягає в тому, що продюсер ніколи не надсилає жодних повідомлень безпосередньо в чергу. Насправді, досить часто продюсер навіть не знає, чи буде взагалі доставлено повідомлення до якоїсь черги.</p> <p>Натомість продюсер може лише надсилати повідомлення на обмінник . Обмінник - це дуже проста річ. З одного боку він отримує повідомлення від продюсерів, а з іншого - переміщує їх у черги. Обмінник повинен точно знати, що робити з отриманим повідомленням. Чи слід додавати його до певної черги? Його слід додати до багатьох черг? Або його слід викинути. Правила для цього визначаються типом обміну.</p> <p>Доступно кілька видів обміну: <em><strong>direct</strong></em>, <em><strong>topic</strong></em>, <em><strong>headers</strong></em> та <em><strong>fanout</strong></em>.</p> <h3 id="режим-fanout"><a href="#режим-fanout" class="header-anchor">#</a> Режим fanout</h3> <p>В режимі <em><strong>fanout</strong></em> обмінник просто транслює всі отримані повідомлення у всі відомі йому черги.</p> <p>Створимо файл <code>./src/event-publisher.js</code>, який буде генерувати послідовність подій</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertExchange</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">LOGS</span><span class="token punctuation">,</span> 
        <span class="token string">'fanout'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> durable<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    
    <span class="token keyword">if</span><span class="token punctuation">(</span> assertion <span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token punctuation">{</span>
          name<span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Task </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          at<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          duration<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> send <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">LOGS</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Event Publisher publish &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>  
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>Від генератора завдань він відрізняється тим, що в ньому створюється обмінник</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token operator">...</span>

<span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertExchange</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">LOGS</span><span class="token punctuation">,</span> 
        <span class="token string">'fanout'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> durable<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span>

</code></pre></div><p>При виклику <code>channel.assertExchange</code> ми повинні вказати ім'я обмінника, тип обміну(в нашому випадку <code>fanout</code> ), налаштування персистентності повідомлень.</p> <p>Наш генератор генерує 10 повідомлень та публікує їх в обміннику.</p> <p>Створимо файл <code>./src/event-logger1.js</code> для першого споживача(підписника)</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertExchange</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">LOGS</span><span class="token punctuation">,</span> 
        <span class="token string">'fanout'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> durable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> exclusive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">bindQueue</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">LOGS</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> 
        <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>Як і у випадку генератора, створюємо обмінник та отримуємо від каналу результат визначення черги. Об'єкт <code>assertion</code> містить ім'я черги для цього примірника логера:  <code>assertion.queue</code>.</p> <p>Коли з'єднання, яке оголосило таку тимчасову чергу, закривається, вона буде видалена, оскільки оголошена як <code>{ exclusive: true }</code>.</p> <p>На наступному кроці слід прив'язати до черги <code>binding</code>- правила, у відповідності з яким обмінник розподіляє повідомлення по чергам. Для режиму fanout маски на визначаються</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token operator">...</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertExchange</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">LOGS</span><span class="token punctuation">,</span> 
        <span class="token string">'fanout'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> durable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> exclusive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">bindQueue</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">LOGS</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span>

</code></pre></div><p>Потім визначаємо обробник повідомлень, який виводить на консоль <code>task.name</code>.</p> <p>Другий логер (файл <code>./src/event-logger2.js</code>)</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertExchange</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">LOGS</span><span class="token punctuation">,</span> 
        <span class="token string">'fanout'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> durable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> exclusive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">bindQueue</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">LOGS</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> 
        <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> duration </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>duration<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>відрізняється від першого лише обробником подій. Він виводить на консоль <code>task.duration</code>.</p> <p>Запустимо 3 консолі: генератор та два логера. Отримаємо:</p> <p>консоль генератора</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/event-publisher
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Event Publisher publish <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">0</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T15:21:03.088Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:173}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Event Publisher publish <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">1</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T15:21:03.094Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:927}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Event Publisher publish <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">2</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T15:21:03.095Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:898}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Event Publisher publish <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">3</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T15:21:03.096Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:120}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Event Publisher publish <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">4</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T15:21:03.096Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:342}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Event Publisher publish <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">5</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T15:21:03.097Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:332}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Event Publisher publish <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">6</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T15:21:03.097Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:712}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Event Publisher publish <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">7</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T15:21:03.098Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:107}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Event Publisher publish <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">8</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T15:21:03.098Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:386}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Event Publisher publish <span class="token string">&quot;{&quot;</span>name<span class="token string">&quot;:&quot;</span>Task <span class="token number">9</span><span class="token string">&quot;,&quot;</span>at<span class="token string">&quot;:&quot;</span><span class="token number">2021</span>-08-23T15:21:03.099Z<span class="token string">&quot;,&quot;</span>duration<span class="token string">&quot;:455}&quot;</span>

</code></pre></div><p>консоль першого логера</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/event-logger1    
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">0</span>                                        
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">1</span>                                                                            
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">2</span>                                                                            
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">3</span>                                                                            
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">4</span>                                                                            
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">5</span>                                                                            
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">6</span>                                                                            
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">7</span>                                                                            
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">8</span>                                                                            
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">9</span>

</code></pre></div><p>консоль другого логера</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/event-logger2    
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">0</span> duration 173ms                         
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">1</span> duration 927ms                                              
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">2</span> duration 898ms                                              
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">3</span> duration 120ms                                              
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">4</span> duration 342ms                                              
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">5</span> duration 332ms                                              
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">6</span> duration 712ms                                              
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">7</span> duration 107ms                                              
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">8</span> duration 386ms                                              
<span class="token number">2021.08</span>.23 <span class="token number">18</span>:21:03: Task <span class="token number">9</span> duration 455ms 

</code></pre></div><p>Таким чином ми маємо можливість використовувати декілька обробників одного потоку подій.</p> <h3 id="режим-direct"><a href="#режим-direct" class="header-anchor">#</a> Режим direct</h3> <p>Режим <em><strong>direct</strong></em> дозволяє обміннику вибірково пересилати повідомлення до черг на основі використання <em><strong>ключа маршрутизації</strong></em>. Повідомлення публікується в обміннику з певним ключем маршрутизації і потрапляє в усі черги, які пов'язані з цим обмінником аналогічним ключем маршрутизації. Ключ маршрутизації - це рядок. Пошук відповідності відбувається за допомогою перевірки рядків на еквівалентність.</p> <p>Створимо файл <code>./src/event-publisher-direct.js</code>, який імітує передачу повідомлень логування</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> messageType <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;warning&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;warning&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;info&quot;</span>
<span class="token punctuation">]</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> assert <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertExchange</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span> 
        <span class="token string">'direct'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> durable<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

    
    <span class="token keyword">if</span><span class="token punctuation">(</span> assert <span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>messageType<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span>messageType<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
          index<span class="token operator">:</span> i
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> send <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span> messageType<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Multiple Types Event Publisher publish &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> 
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre></div><p>Від попереднього генератора подій він відрізняється типом обміну, який вказаний при створенні обмінника, та способом
публікації повідомлення: ключ маршрутизації вказано, як другий аргумент виклику <code>channel.publish</code>.</p> <p>Генератор надсилає в обмінник повідомлення, відповідні до елементів масиву <code>messageType</code>.</p> <p>Створимо файл <code>./src/event-logger-direct.js</code></p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertExchange</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span> 
        <span class="token string">'direct'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> durable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> exclusive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">bindQueue</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">bindQueue</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">bindQueue</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span>

    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> 
        <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>Цей логер здійснює прив'язку своєї черги за допомогою <code>binding</code> на три ключі маршрутизації: <code>info</code>,
<code>warning</code>, <code>error</code>.</p> <p>Другий логер (файл <code>./src/event-debug-direct.js</code>)</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertExchange</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span> 
        <span class="token string">'direct'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> durable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> exclusive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">bindQueue</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span> <span class="token string">'debug'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">bindQueue</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">bindQueue</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span>

    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> 
        <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>налаштований на інший набір типів повідомлень: <code>debug</code>, <code>warning</code>, <code>error</code>.</p> <p>Обмінник буде надсилати повідомлення типу <code>warning</code> та <code>error</code> до обох черг.</p> <p>Після запуску генератора та логерів в окремих консолях отримаємо результат:</p> <p>консоль генератора</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/event-publisher-direct
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: Multiple Types Event Publisher publish <span class="token string">&quot;{&quot;</span><span class="token builtin class-name">type</span><span class="token string">&quot;:&quot;</span>info<span class="token string">&quot;,&quot;</span>index<span class="token string">&quot;:0}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: Multiple Types Event Publisher publish <span class="token string">&quot;{&quot;</span><span class="token builtin class-name">type</span><span class="token string">&quot;:&quot;</span>debug<span class="token string">&quot;,&quot;</span>index<span class="token string">&quot;:1}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: Multiple Types Event Publisher publish <span class="token string">&quot;{&quot;</span><span class="token builtin class-name">type</span><span class="token string">&quot;:&quot;</span>warning<span class="token string">&quot;,&quot;</span>index<span class="token string">&quot;:2}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: Multiple Types Event Publisher publish <span class="token string">&quot;{&quot;</span><span class="token builtin class-name">type</span><span class="token string">&quot;:&quot;</span>error<span class="token string">&quot;,&quot;</span>index<span class="token string">&quot;:3}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: Multiple Types Event Publisher publish <span class="token string">&quot;{&quot;</span><span class="token builtin class-name">type</span><span class="token string">&quot;:&quot;</span>debug<span class="token string">&quot;,&quot;</span>index<span class="token string">&quot;:4}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: Multiple Types Event Publisher publish <span class="token string">&quot;{&quot;</span><span class="token builtin class-name">type</span><span class="token string">&quot;:&quot;</span>warning<span class="token string">&quot;,&quot;</span>index<span class="token string">&quot;:5}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: Multiple Types Event Publisher publish <span class="token string">&quot;{&quot;</span><span class="token builtin class-name">type</span><span class="token string">&quot;:&quot;</span>info<span class="token string">&quot;,&quot;</span>index<span class="token string">&quot;:6}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: Multiple Types Event Publisher publish <span class="token string">&quot;{&quot;</span><span class="token builtin class-name">type</span><span class="token string">&quot;:&quot;</span>info<span class="token string">&quot;,&quot;</span>index<span class="token string">&quot;:7}&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: Multiple Types Event Publisher publish <span class="token string">&quot;{&quot;</span><span class="token builtin class-name">type</span><span class="token string">&quot;:&quot;</span>info<span class="token string">&quot;,&quot;</span>index<span class="token string">&quot;:8}&quot;</span>

</code></pre></div><p>консоль першого логера</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/event-logger-direct
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">0</span>: info                                 
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">2</span>: warning                                                                    
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">3</span>: error                                                                      
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">5</span>: warning                                                                    
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">6</span>: info                                                                          
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">7</span>: info                                                                          
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">8</span>: info 

</code></pre></div><p>консоль другого логера</p> <div class="language-bash extra-class"><pre class="language-bash"><code>D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/event-debug-direct
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">1</span>: debug                                 
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">2</span>: warning                                                                    
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">3</span>: error                                                                      
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">4</span>: debug                                                                        
<span class="token number">2021.08</span>.23 <span class="token number">19</span>:30:00: <span class="token number">5</span>: warning

</code></pre></div><h3 id="режим-topic"><a href="#режим-topic" class="header-anchor">#</a> Режим topic</h3> <p>В режимі <em><strong>topic</strong></em> повідомлення, надіслані до обмінника, не можуть мати довільний ключ-маршрутизатор - це повинен бути список слів, розділених крапками. Слова можуть бути будь-якими, але зазвичай вони вказують на деякі функції, пов’язані з повідомленням. Ключ прив’язки також повинен бути в тій самій формі. Логіка обміну topic подібна до direct - повідомлення, надіслане з певним ключем маршрутизації, буде доставлено до всіх черг, які пов'язані відповідним ключем прив'язки. Однак є два важливі особливі випадки використання масок для прив’язки ключів:</p> <ul><li><code>*</code> (зірочка) може замінити рівно одне слово.</li> <li><code>#</code> (хеш) може замінити нуль або більше слів.</li></ul> <p>Якщо ми надішлемо повідомлення з ключем маршрутизації, яке не відповідає ні одній  масці, воно буде втрачене.</p> <p>Створимо файл <code>./src/event-publisher-topic.js</code> для генератора подій</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> messageType <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;class1.info.start&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;class1.debug&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;class2.warning&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;class2.error&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;class1.debug&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;class3.warning&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;class1.info.run&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;class2.info.start&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;class2.info.start&quot;</span>
<span class="token punctuation">]</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> assert <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertExchange</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> 
        <span class="token string">'topic'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> durable<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

    
    <span class="token keyword">if</span><span class="token punctuation">(</span> assert <span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>messageType<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span>messageType<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
          index<span class="token operator">:</span> i
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> send <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> messageType<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Multiple Types Event Publisher publish &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> 
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre></div><p>Тепер типи наших повідомлень відповідають вимогам для ключів маршрутизації режиму topic. При створенні обмінника вказуємо тип обміну <code>topic</code>.</p> <p>Створимо файл <code>./src/event-logger-topic.js</code> для логера, який вібірково (на основі використання маски) виводить на консоль
повідомлення</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> args <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Usage: node ./src/event-logger-topic &lt;class&gt;.&lt;severity&gt;.&lt;action&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertExchange</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> 
        <span class="token string">'topic'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> durable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> exclusive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    args<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        channel<span class="token punctuation">.</span><span class="token function">bindQueue</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> config<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> 
        <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>routingKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>task<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>Саму маску, яка використовується в прив'язці черги, отримуємо з командного рядка. Ключ прив'язки складається з трьох
частин: <code>&lt;class&gt;.&lt;severity&gt;.&lt;action&gt;</code>.</p> <p>Будемо запускати цей логер з різними масками. Також після запуску логера треба запустити генератор подій.</p> <p>Для запуску <code>node ./src/event-logger-topic &quot;#&quot;</code> отримаємо</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/event-logger-topic <span class="token string">&quot;#&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:04:06: class1.info.start: <span class="token number">0</span>: class1.info.start
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:04:06: class1.debug: <span class="token number">1</span>: class1.debug                    
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:04:06: class2.warning: <span class="token number">2</span>: class2.warning                      
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:04:06: class2.error: <span class="token number">3</span>: class2.error                          
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:04:06: class1.debug: <span class="token number">4</span>: class1.debug                              
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:04:06: class3.warning: <span class="token number">5</span>: class3.warning                      
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:04:06: class1.info.run: <span class="token number">6</span>: class1.info.run                  
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:04:06: class2.info.start: <span class="token number">7</span>: class2.info.start          
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:04:06: class2.info.start: <span class="token number">8</span>: class2.info.start


</code></pre></div><p>Як бачимо, під маску <code>#</code> підпадають будь-які повідомлення.</p> <p>Для запуску <code>node ./src/event-logger-topic &quot;*.*.start&quot;</code> отримаємо</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/event-logger-topic <span class="token string">&quot;*.*.start&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:07:37: class1.info.start: <span class="token number">0</span>: class1.info.start
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:07:37: class2.info.start: <span class="token number">7</span>: class2.info.start          
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:07:37: class2.info.start: <span class="token number">8</span>: class2.info.start   

</code></pre></div><p>Як бачимо, під маску <code>*.*.start</code> підпадають повідомлення, ключ маршрутизації яких закінчується на <code>start</code> та має три слова.</p> <p>Для запуску <code>node ./src/event-logger-topic &quot;class2.#&quot;</code> отримаємо</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/event-logger-topic <span class="token string">&quot;class2.#&quot;</span>
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:10:38: class2.warning: <span class="token number">2</span>: class2.warning
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:10:38: class2.error: <span class="token number">3</span>: class2.error                          
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:10:38: class2.info.start: <span class="token number">7</span>: class2.info.start          
<span class="token number">2021.08</span>.23 <span class="token number">20</span>:10:38: class2.info.start: <span class="token number">8</span>: class2.info.start

</code></pre></div><p>Як бачимо, під маску <code>class2.#</code> підпадають повідомлення, ключ маршрутизації яких починається з <code>class2</code> та має довільну кількість слів.</p> <p>Таким чином, використання режиму topic дає можливість гнучкого налаштування вибіркового оброблення повідомлень.</p> <h2 id="реалізація-шаблону-rpc"><a href="#реалізація-шаблону-rpc" class="header-anchor">#</a> Реалізація шаблону RPC</h2> <p>Віддалений виклик процедур (Remote Procedure Call, RPC) - клас технологій, що дозволяють програмам викликати функції або процедури на віддалених вузлах. Зазвичай реалізація RPC-технології включає два компоненти: мережевий протокол для обміну в режимі клієнт-сервер і мова сериализации об'єктів.</p> <p>Ідея виклику віддалених процедур полягає в розширенні механізму передачі управління і даних усередині програми, що виконується на одному вузлі, на передачу управління і даних через мережу. Засоби віддаленого виклику процедур призначені для полегшення організації розподілених обчислень і створення розподілених клієнт-серверних інформаційних систем. Найбільша ефективність використання RPC досягається в тих додатках, в яких існує інтерактивний зв'язок між віддаленими компонентами з невеликим часом відповідей і відносно малою кількістю переданих даних. Такі додатки називаються RPC-орієнтованими.</p> <p>В EDA віддалений виклик процедур реалізують наступним чином</p> <center style="border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);padding:1em;"><img src="https://www.plantuml.com/plantuml/svg/TP312i8m38RlUOhGg_W2CiPmPq7N7RrK3JgiNTTseczlrcxY1fwIzF_J_oE53yg5_g41B3VDkR7A12nrGroKHr7jot4K0AVsXM97tgihuTQrTt82PviLTOUqHrrFFXnDbfKtPGpfF1SBgv-iLhyNHZ8NvBGvblmIIN9FpWOOITTvJDxW8BeKZIlk-EUwXKZ57ldF8AEQoi0r-LY5oCdlAUfNWO8n-NWV" alt="uml diagram"></center> <p>Клієнт використовує чергу для передачі повідмлення про віддалений виклик. Також у повідомленні він передає назву черги для відправлення результату з боку сервера. Сервер отримує повідомлення про виклик з черги викликів, здійснює оброблення та надсилає відповідь в чергу відповідей, налаштування якої були задані клієнтом у повідомленні про виклик.</p> <p>Назву черги для зворотного виклику клієнт може передати за допомогою властивості <code>message.properties.replyTo</code>.</p> <p>Сервер може виконувати оброблення декількох викликів асинхронно, тому послідовність відповідей в черзі відповідей може не співпадати з послідовністю викликів. Тобто кожен виклик повинен мати унікальний ідентифікатор, який передається клієнтом. Сервер потім використовує цей ідентифікатор для маркування відповідної відповіді. Тоді клієнт, отримавши повідомлення-відповідь, може співвіднести її з відповідним запитом.</p> <p>Таку ідентифікацію можна здійснити через властивість <code>message.properties.correlationId</code>.</p> <p>Створимо файл <code>./src/call-generator.js</code> для клієнта</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> uuid <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>v4
<span class="token keyword">const</span> <span class="token punctuation">{</span> findIndex <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">let</span> calls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">i</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    index<span class="token operator">:</span> i<span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> assertion <span class="token operator">=</span> <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> exclusive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>

    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span> assertion<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> refCallIndex <span class="token operator">=</span> <span class="token function">findIndex</span><span class="token punctuation">(</span>calls<span class="token punctuation">,</span> <span class="token parameter">call</span> <span class="token operator">=&gt;</span> call<span class="token punctuation">.</span>id <span class="token operator">==</span> msg<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>correlationId<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>refCallIndex <span class="token operator">&gt;=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nrpc: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>calls<span class="token punctuation">[</span>refCallIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\nresponse: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> noAsk<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    calls<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span> <span class="token parameter">call</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">send rpc: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            channel<span class="token punctuation">.</span><span class="token function">sendToQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">RPC</span><span class="token punctuation">,</span>
                Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    correlationId<span class="token operator">:</span> call<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                    replyTo<span class="token operator">:</span> assertion<span class="token punctuation">.</span>queue
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//call.timeout)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>



</code></pre></div><p>Бібліотека <a href="https://www.npmjs.com/package/uuid" target="_blank" rel="noopener noreferrer">uuid<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> буде нами використана для генерації унікальних ідентифікаторів.</p> <p>Наш генератор створює послідовність віддалених викликів(6 викликів) через випадкові інтервали часу.</p> <p>Спочатку створюємо тимчасову чергу відповідей та отримує її налаштування від брокера повідомлень. Визначаємо обробник повідомлень-відповідей, в якому співвідносимо відповідь і виклик на основі співпадіння <code>call.id == msg.properties.correlationId</code>. Потів виводимо на консоль повідомлення про успішне завершення віддаленого виклику.</p> <p>Для відправлення повідомлень-викликів використовуємо заздалегідь відому чергу викликів, яку &quot;слухає&quot; сервер. При надсиланні повідомлень задаємо значення  <code>correlationId</code> та <code>replyTo</code>.</p> <p>Створимо файл <code>./src/call-server.js</code> для сервера</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY.MM.DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">AMQP_CONNECTION_URL</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">await</span> channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">RPC</span><span class="token punctuation">,</span><span class="token punctuation">{</span>durable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// channel.prefetch(1);</span>
    
    channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token constant">RPC</span><span class="token punctuation">,</span> 
        <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> call <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token punctuation">{</span>
                index<span class="token operator">:</span> call<span class="token punctuation">.</span>index
            <span class="token punctuation">}</span>

            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">sendToQueue</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>replyTo<span class="token punctuation">,</span>
                Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    correlationId<span class="token operator">:</span> msg<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>correlationId
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                channel<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    
            <span class="token punctuation">}</span><span class="token punctuation">,</span> call<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
            
            
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>Сервер &quot;слухає&quot; відому всім клієнтам чергу викликів. В обробнику повідомлень здійснюється оброблення, надсилання
повідомлення-відповіді в чергу <code>msg.properties.replyTo</code>, асоційовану з клієнтом. Це повідомлення має той самий
<code>correlationId</code>, що і відповідний запит. Після вдалого оброблення запиту сервер підтверджує отримання повідомлення.</p> <p>Запустимо сервер і клієнт у відповідних консолях та отримаємо результат.</p> <p>консоль клієнта</p> <div class="language-bash extra-class"><pre class="language-bash"><code>D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/call-generator
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:39: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:0,<span class="token string">&quot;timeout&quot;</span>:4931,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b986ba8a-af8e-482f-8839-5da6a017b603&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:39: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:3391,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;9100a684-a601-4429-994e-a7779e4d9dca&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:39: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:4173,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;0bc9d498-24c9-4246-9bd3-c550d7dc2983&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:39: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:3,<span class="token string">&quot;timeout&quot;</span>:1692,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;5583900c-b566-419e-bfd8-cce328efdce3&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:39: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:4,<span class="token string">&quot;timeout&quot;</span>:4810,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;e0b628db-2bfe-4a17-bf68-80d3dc501189&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:39: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:5,<span class="token string">&quot;timeout&quot;</span>:1584,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;3a19277e-3552-41dd-bdaa-68e84dd5c4e4&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:41:         
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:5,<span class="token string">&quot;timeout&quot;</span>:1584,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;3a19277e-3552-41dd-bdaa-68e84dd5c4e4&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:5<span class="token punctuation">}</span>                                                                                                             
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:41:                                                                                          
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:3,<span class="token string">&quot;timeout&quot;</span>:1692,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;5583900c-b566-419e-bfd8-cce328efdce3&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:3<span class="token punctuation">}</span>                                  
                                                                                                                                  
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:43:                                                                                         
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:3391,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;9100a684-a601-4429-994e-a7779e4d9dca&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:1<span class="token punctuation">}</span>                                                                                        
                                                                                                                                  
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:43:                                                                                         
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:4173,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;0bc9d498-24c9-4246-9bd3-c550d7dc2983&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:2<span class="token punctuation">}</span>                                  
                                                                                                                                  
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:44:                                                                                          
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:4,<span class="token string">&quot;timeout&quot;</span>:4810,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;e0b628db-2bfe-4a17-bf68-80d3dc501189&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:4<span class="token punctuation">}</span>                                  
                                                                                                                                  
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:26:44:                                                                                         
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:0,<span class="token string">&quot;timeout&quot;</span>:4931,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b986ba8a-af8e-482f-8839-5da6a017b603&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:0<span class="token punctuation">}</span>   

</code></pre></div><p>Бачимо, що клієнт відправляє всі повідомлення, які на сервері виконуюються асинхронно, тому послідовність відповідей не співпадає з послідовністю викликів. Проте використання <code>correlationId</code> дозволяє вірно співвіднести запити та відповіді.</p> <p>Якщо задати обмеження, що сервер отримує наступний виклик тільки після завершення поточного: <code>channel.prefetch(1)</code>, послідовність викликів та відповідей буде співпадати.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
D:<span class="token punctuation">\</span>docs<span class="token punctuation">\</span>EDU<span class="token punctuation">\</span><span class="token number">2021</span><span class="token punctuation">\</span>eda<span class="token punctuation">\</span>javascript-nodejs<span class="token operator">&gt;</span>node ./src/call-generator  
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:33:58: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:0,<span class="token string">&quot;timeout&quot;</span>:3661,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;7b40ff5b-9204-4b69-a9ad-138157f39074&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:33:58: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:4167,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b4621c12-324e-4e00-89df-c70095dd538b&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:33:58: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:1730,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;afd6c080-ffdc-4207-a043-a616dbf77b3d&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:33:58: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:3,<span class="token string">&quot;timeout&quot;</span>:2485,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;c7ade456-197e-4f2d-b6b4-7ce8382b526b&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:33:58: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:4,<span class="token string">&quot;timeout&quot;</span>:3424,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1246b715-48db-451d-bf04-b045d7303cfd&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:33:58: send rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:5,<span class="token string">&quot;timeout&quot;</span>:1543,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;6d546e68-2ccd-4b9e-b047-164c7addd1b2&quot;</span><span class="token punctuation">}</span>
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:34:02:         
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:0,<span class="token string">&quot;timeout&quot;</span>:3661,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;7b40ff5b-9204-4b69-a9ad-138157f39074&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:0<span class="token punctuation">}</span>                                                                                        
                                                                                                                                  
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:34:07:                                                                                         
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:4167,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b4621c12-324e-4e00-89df-c70095dd538b&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:1<span class="token punctuation">}</span>                                  
                                                                                                                                  
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:34:09:                                                                                         
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:1730,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;afd6c080-ffdc-4207-a043-a616dbf77b3d&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:2<span class="token punctuation">}</span>                                  
                                                                                                                                  
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:34:11:                                                                                         
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:3,<span class="token string">&quot;timeout&quot;</span>:2485,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;c7ade456-197e-4f2d-b6b4-7ce8382b526b&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:3<span class="token punctuation">}</span>                                  
                                                                                                                                  
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:34:15:                                                                                         
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:4,<span class="token string">&quot;timeout&quot;</span>:3424,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1246b715-48db-451d-bf04-b045d7303cfd&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:4<span class="token punctuation">}</span>                                  
                                                                                                                                  
<span class="token number">2021.08</span>.23 <span class="token number">21</span>:34:17:                                                                                         
rpc: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:5,<span class="token string">&quot;timeout&quot;</span>:1543,<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;6d546e68-2ccd-4b9e-b047-164c7addd1b2&quot;</span><span class="token punctuation">}</span>
response: <span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:5<span class="token punctuation">}</span>                                                  

</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/boldak/dis-edu/edit/master/docs/eda/13.rabbitmq.md" target="_blank" rel="noopener noreferrer">Ви можете покращити цю сторінку</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/25/2021, 11:36:11 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/swagger/12.api.html" class="prev">
        Специфікація API
      </a></span> <span class="next"><a href="/docs/msa/14.msa.html">
        Реалізація шаблонів мікросервісної архітектури
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/docs/assets/js/app.6573e971.js" defer></script><script src="/docs/assets/js/2.43c74522.js" defer></script><script src="/docs/assets/js/29.0d739a8d.js" defer></script>
  </body>
</html>
