<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Scripted Query сервіси | Розподілені інформаційні системи</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/docs/faviconCustom.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="description" content="Курс лекцій">
    
    <link rel="preload" href="/docs/assets/css/0.styles.f5591410.css" as="style"><link rel="preload" href="/docs/assets/js/app.6573e971.js" as="script"><link rel="preload" href="/docs/assets/js/2.43c74522.js" as="script"><link rel="preload" href="/docs/assets/js/21.19f4d8a1.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.ae09fb39.js"><link rel="prefetch" href="/docs/assets/js/11.a892532e.js"><link rel="prefetch" href="/docs/assets/js/12.502d8f9b.js"><link rel="prefetch" href="/docs/assets/js/13.19ba463b.js"><link rel="prefetch" href="/docs/assets/js/14.b9bc508f.js"><link rel="prefetch" href="/docs/assets/js/15.8378044f.js"><link rel="prefetch" href="/docs/assets/js/16.c5ab21e3.js"><link rel="prefetch" href="/docs/assets/js/17.056e16ea.js"><link rel="prefetch" href="/docs/assets/js/18.d77e96ca.js"><link rel="prefetch" href="/docs/assets/js/19.b664be5a.js"><link rel="prefetch" href="/docs/assets/js/20.d99a3a28.js"><link rel="prefetch" href="/docs/assets/js/22.c12e4cd6.js"><link rel="prefetch" href="/docs/assets/js/23.cea9fca9.js"><link rel="prefetch" href="/docs/assets/js/24.03b428d0.js"><link rel="prefetch" href="/docs/assets/js/25.1189308b.js"><link rel="prefetch" href="/docs/assets/js/26.73a0e546.js"><link rel="prefetch" href="/docs/assets/js/27.94f39345.js"><link rel="prefetch" href="/docs/assets/js/28.a6b74891.js"><link rel="prefetch" href="/docs/assets/js/29.0d739a8d.js"><link rel="prefetch" href="/docs/assets/js/3.418ab320.js"><link rel="prefetch" href="/docs/assets/js/30.d3e49c4f.js"><link rel="prefetch" href="/docs/assets/js/31.5a79ea41.js"><link rel="prefetch" href="/docs/assets/js/32.892f4cee.js"><link rel="prefetch" href="/docs/assets/js/33.43c31432.js"><link rel="prefetch" href="/docs/assets/js/34.aa8b7542.js"><link rel="prefetch" href="/docs/assets/js/35.106db34a.js"><link rel="prefetch" href="/docs/assets/js/36.decaa943.js"><link rel="prefetch" href="/docs/assets/js/37.35adf566.js"><link rel="prefetch" href="/docs/assets/js/38.b395a8e9.js"><link rel="prefetch" href="/docs/assets/js/4.f33b38e3.js"><link rel="prefetch" href="/docs/assets/js/5.335a55c0.js"><link rel="prefetch" href="/docs/assets/js/6.98f769b8.js"><link rel="prefetch" href="/docs/assets/js/7.eaf79c7b.js"><link rel="prefetch" href="/docs/assets/js/8.721b5dad.js"><link rel="prefetch" href="/docs/assets/js/9.e42fd085.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.f5591410.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">Розподілені інформаційні системи</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div> <a href="https://github.com/boldak/dis-edu" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div> <a href="https://github.com/boldak/dis-edu" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/docs/intro/" class="sidebar-heading clickable"><span>Вступ</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/arch/" class="sidebar-heading clickable"><span>Архітетура розподілених інформаційних систем</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/components-interaction/" class="sidebar-heading clickable router-link-active open"><span>Реалізація взаємодії компонентів розподіленої інформаційної системи</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/components-interaction/01.express.html" class="sidebar-link">Розроблення веб-сервера за допомогою express.js</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/components-interaction/01.express.html#підготовлення-проекту" class="sidebar-link">Підготовлення проекту</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/components-interaction/01.express.html#фаилова-структура" class="sidebar-link">Файлова структура</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/01.express.html#встановлення-залежностеи" class="sidebar-link">Встановлення залежностей</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/01.express.html#конфігурування-сервера" class="sidebar-link">Конфігурування сервера</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/01.express.html#першии-запуск" class="sidebar-link">Перший запуск</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/01.express.html#налаштування-проміжного-пз-доступ-до-статичних-фаилів" class="sidebar-link">Налаштування проміжного ПЗ. Доступ до статичних файлів</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/01.express.html#оброблення-запитів" class="sidebar-link">Оброблення запитів</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/01.express.html#оброблення-параметрів-запиту" class="sidebar-link">Оброблення параметрів запиту</a></li></ul></li><li><a href="/docs/components-interaction/03.restfull-services.html" class="sidebar-link">RESTfull сервіси</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/components-interaction/03.restfull-services.html#підготовлення-проекту" class="sidebar-link">Підготовлення проекту</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/03.restfull-services.html#розроблення-контролера" class="sidebar-link">Розроблення контролера</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/03.restfull-services.html#розроблення-роутера" class="sidebar-link">Розроблення роутера</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/03.restfull-services.html#перевірка-працездатності-сервісу" class="sidebar-link">Перевірка працездатності сервісу</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/03.restfull-services.html#автоматизація-тестування-сервісу" class="sidebar-link">Автоматизація тестування сервісу</a></li></ul></li><li><a href="/docs/components-interaction/04.graphql.html" class="sidebar-link">GraphQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/components-interaction/04.graphql.html#схема" class="sidebar-link">Схема</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/components-interaction/04.graphql.html#об-єктні-типи" class="sidebar-link">Об'єктні типи</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/04.graphql.html#скалярні-типи" class="sidebar-link">Скалярні типи.</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/04.graphql.html#інтерфеиси" class="sidebar-link">Інтерфейси</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/04.graphql.html#query-mutations-subscriptions" class="sidebar-link">Query, mutations, subscriptions</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/04.graphql.html#resolvers" class="sidebar-link">Resolvers</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/04.graphql.html#розроблення-graphql-сервісу" class="sidebar-link">Розроблення GraphQL сервісу</a></li></ul></li><li><a href="/docs/components-interaction/05.sse.html" class="sidebar-link">Push-нотифікація з використанням Server-Sent Events</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/components-interaction/05.sse.html#вимоги-до-push-сервера" class="sidebar-link">Вимоги до push-сервера</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/05.sse.html#використання-eventsource" class="sidebar-link">Використання EventSource</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/05.sse.html#розроблення-push-сервісу" class="sidebar-link">Розроблення push-сервісу</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/05.sse.html#першии-запуск" class="sidebar-link">Перший запуск</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/05.sse.html#вдосконалення-сервісу" class="sidebar-link">Вдосконалення сервісу</a></li></ul></li><li><a href="/docs/components-interaction/06.scripted-query.html" aria-current="page" class="active sidebar-link">Scripted Query сервіси</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/components-interaction/06.scripted-query.html#швидке-розроблення-програм-low-code-development-platform" class="sidebar-link">Швидке розроблення програм. Low-Code Development Platform</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/06.scripted-query.html#принцип-делегуванням-сценарію-оброблення-даних" class="sidebar-link">Принцип делегуванням сценарію оброблення даних</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/06.scripted-query.html#розроблення-сервісу-з-підтримкою-sq" class="sidebar-link">Розроблення сервісу з підтримкою SQ</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/06.scripted-query.html#обробник-sq-запитів-з-підтримкою-асинхроних-операціи" class="sidebar-link">Обробник SQ-запитів з підтримкою асинхроних операцій</a></li><li class="sidebar-sub-header"><a href="/docs/components-interaction/06.scripted-query.html#обробник-sq-запитів-з-підтримкою-sse" class="sidebar-link">Обробник SQ-запитів з підтримкою SSE</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/swagger/" class="sidebar-heading clickable"><span>Прикладний програмний інтерфейс сервісів</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/eda/" class="sidebar-heading clickable"><span>Реалізація взаємодії компонентів в EDA</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/msa/" class="sidebar-heading clickable"><span>Реалізація взаємодії сервісів в MSA</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="scripted-query-сервіси"><a href="#scripted-query-сервіси" class="header-anchor">#</a> Scripted Query сервіси</h1> <h2 id="швидке-розроблення-програм-low-code-development-platform"><a href="#швидке-розроблення-програм-low-code-development-platform" class="header-anchor">#</a> Швидке розроблення програм. Low-Code Development Platform</h2> <p>В багатьох предметних областях застосування інформаційних систем виникає завдання &quot;швидкого&quot; розроблення прикладного програмного забезпечення (застосунків) групою розробників, до складу якої можуть входити фахівці, які можуть не мати знань або навичок програмування, а також фахівці з ІТ-технологій, що мають належний досвід розроблення програмних систем.</p> <p>Також необхідно враховувати наступне.</p> <p><em><strong>Стислі терміни.</strong></em> Необхідно максимально швидко розробити застосунки, які відповідають сьогоденним вимогам. Збільшення термінів розробки підвищує вірогідність настільки вагомих змін вимог до застосунку, що він морально застаріває ще до закінчення розроблення.</p> <p><em><strong>Нечітко визначені та(або) такі, що постійно змінюються в процесі розроблення, вимоги.</strong></em> Процес формулювання вимог до розроблюваного застосунку йде одночасно ( з незначним випередженням) з процесом розроблення, що обумовлює високу змінюваність вимог.</p> <p><em><strong>Обмеження бюджету.</strong></em> Відсутність в бюджеті виконуваного дослідження коштів для найму великої команди розробників на довготривалий термін.</p> <p><em><strong>Можливість декомпозиції засобів автоматизації</strong></em> на окремі невеликі функціональні компоненти (застосунки) з чітко визначеною функціональністю та мінімізованими взаємозалежностями.</p> <p><em><strong>Необхідність демонстрації графічного інтерфейсу користувача безпосередньо на прототипі застосунку.</strong></em> Це дозволяє якнайкраще досягнути ергономічності застосунку, бажаної для користувачів.</p> <p>Виконання перелічених умов досягається за рахунок використання технології швидкої розробки, а саме платформи розробки «низького» коду (<strong>Low-Code Development Platform</strong>, LCDP), яка є середовищем розробки прикладного програмного забезпечення з допомогою графічного інтерфейсу користувача замість ручного програмування.</p> <p>Такі платформи, як правило, функціонують на основі модельного, декларативного підходу, коли кінцевий користувач диктує дизайн програми за допомогою маніпуляцій перетягуванням або створення простих описів.</p> <p>Технологія LCDP передбачає використання типових алгоритмів оброблення даних, які описуються як комбінація типових операцій, що заздалегідь реалізовані в системі.Ця передумова є певним викликом з огляду на необхідну різноманітність та складність алгоритмів оброблення даних, які використовуються в програмних застосунках. Тому необхідно забезпечувати можливість реалізації специфічної функціональності за рахунок вбудовування ручного програмування, яке може здійснити ІТ-фахівець належної кваліфікації.</p> <p>Розглянемо веб-застосунок з точки зору LCDP. В браузер користувача повинно завантажитися базове програмне забезпечення, яке інтерпретує декларативну конфігурацію застосунку. Ця конфігурація може містити вбудовування ручного коду. В цьому випадку такий код повинен виконуватися на боці клієнта (в браузері). Це накладає певні обмеження на об'єм вбудованого коду з огляду на обмеженість доступних ресурсів браузера (такий собі варіант &quot;товстого&quot; клієнта в браузері). У випадку, коли такий код використовує RESTfull сервіс, що надає CRUD-інтерфейс до деяких сутностей на серверному боці, не вдається зняти такі обмеження, тому що вбудований програмний код контролера все одно повинен виконуватися в браузері. В тому випадку, коли функціональність контролера переноситься на серверний бік, ми вимушені позбавлятися универсальності сервісу та перерозташовувати серверну частину кожен раз, коли змінюється логіка контроллера.</p> <h2 id="принцип-делегуванням-сценарію-оброблення-даних"><a href="#принцип-делегуванням-сценарію-оброблення-даних" class="header-anchor">#</a> Принцип делегуванням сценарію оброблення даних</h2> <p>Ідея принципу взаємодії програмних компонентів з делегуванням сценарію оброблення даних (<strong>Scripted Query</strong>, SQ) полягає в тому,
щоб визначити вбудовування коду на клієнті, а потім делегувати виконання цього коду спеціальному сервісу.</p> <p>Такий розподіл функціональних обов’язків між ресурсами системи дозволяє:</p> <ul><li>Зберегти всі переваги «швидкого» розроблення програм для  вбудовування ручного програмування.</li> <li>Уникнути стадії  перерозташування  програмного коду під час розроблення застосунків.</li> <li>Перейти до так званої безсерверної (serverless) технології (з точки зору розробника застосунків), коли відсутня необхідність адміністрування серверної частини.</li></ul> <p>Використання цього принципу надає можливість в інформаційній системі виділити в окремі компоненти сервіс, який здійснює управління конфігураціями застосунків та сервіси для реалізації сценаріїв оброблення даних (реалізації бізнес-логіки контролерів застосунків).</p> <center style="border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);padding:1em;"><img src="https://www.plantuml.com/plantuml/svg/fPB1IiD048RlUOgXzxn1A0KzUl0k7a8JYbXZiF4aGfBgkI3Iks-G1eEbRT9N-EUD_DF8bYqv59p3iZFvT-RRFpkQ9VvJylmmTHnXnFxutf-4ChYwkBmMxB55eRc-eT4KEnG3UJdeseWUWr34Z-FPZQcruNdKLfhfN5FDXaFpqLAv3AjW9VXYXnIbBZKJdMFFf429hIvHezQ5hIvHOUNYXx2PveJbSEesFBF3scXlJzY3iz7_Wuy6AoPSwMRLX_zDpXfhVJyXVNLCvmvuFBqBeqJaIErvl2LTqK-spVlCjaZD1X_zbZNOE1t0SVRVLFVmhwsAsrhO2KTX5F0P_G80" alt="uml diagram"></center> <p>Розглянемо процес завантаження та роботи веб-застосунку в такій системі.</p> <center style="border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);padding:1em;"><img src="https://www.plantuml.com/plantuml/svg/TPBDJi9G48NtzoacNIc15s1XCB9mGI89kdDJ0LVO9gMOk9EYk35YYC74bRp1XKWelts5cJVotDO22RXfUZiptvnpRWjDt_Ryrbr3ARlgknvTDUiUsKso-8lNyiYXj2MG3ezPoukbRjoMKxEz1wgKJvEsFazubECfwkZ4J1lTArxpt59Lr_4zju6k8Ky06yj0seHwX8C6So43zAwaT-tWT10qH-EIGxBCEcmzlwXS4ls3njeH3dZo0hWK_GF62bQUOqYnN57Agz-IUm-lG6PJRjRKI9NEYcNY20WDxqzn3alMgkxK27CgpYXtib6J9_w8zPgW8iAwDUtxa8vA1v9PocJoqF-EKi0X72GfuvqEnsbcC6hMOsKNvWBZ7GedF3Fkv_jN1jaxSZ7sYImYz0Gf3fRnUIZTE30Dte1d1vEaRP1qP2Gce6DbKjkG-l028OQLNW04xT3bBHr857sZD8NUXRp2aDug-pFQXo1Jr_7lOfBf0j9J1Tm7_jnV" alt="uml diagram"></center> <p>Користувач здійснює завантаження веб-застосунку з сервісу управління веб-застосунками (інтерпретатор UI + конфігурація), в процесі реалізації логіки контролера веб-застосунок делегує виконання сценарію оброблення даних спеціальному сервісу, який підртимує SQ.</p> <p>Як бачимо, відповідальність програмного коду, що виконується в браузері, обмежується інтерпретацією конфігурації
веб-застосунку, логіка контролера, більшою мірою, може бути інкапсульована в сценаріях оброблення даних, які виконуються в спеціальному сервісі.</p> <p>При цьому, зрозуміло, необхідно забезпечити підтримку CORS.</p> <p>Також до обмежень такого способу взаємодії відносяться вимоги до мови опису сценаріїв та обмеження їх виконання в сервісі оброблення даних.</p> <p>Бажано, щоб мова була такою самою, яка використовується для вбудовування коду на клієнтському боці, щоб вона не потребувала
попередньої компіляції (сценарій повинен інтерпретуватися на серверному боці). Тобто мова йде або про деяку синтетичну мета-мову, наближену до предметної області, або про універсальну мову програмування, наприклад javascript.</p> <p>При виконанні сценаріїв застосовуються ресурси серверної частини, тому слід передбачити певну політику обмеження на доступ
до ресурсів з боку виконуваних сценаріїв. Також треба передбачити способи сповіщення про виключні ситуації, що можуть
виникнути під час виконання сценаріїв. Ще бажано забезпечити способи відлагодження сценаріїв (способи отримання проміжних результатів виконання). Тут складність полягає в тому, що сценарій виконується на серверному боці, а контроль виконання
треба здійснювати в браузері.</p> <h2 id="розроблення-сервісу-з-підтримкою-sq"><a href="#розроблення-сервісу-з-підтримкою-sq" class="header-anchor">#</a> Розроблення сервісу з підтримкою SQ</h2> <p>Виходячи з перелічених міркувань, приступимо до реалізації сервісу з підтримкою SQ.</p> <p>В якості мови опису сценаріїв будемо використовувати javascript, а для їх виконання на серверному боці - модуль <a href="https://nodejs.org/api/vm.html" target="_blank" rel="noopener noreferrer">vm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, що входить до ядра node.js.</p> <p>Цей модуль надає sandbox для компіляції та виконання скриптів в контексті V8 Virtual Machine. Код javascript може бути скомпільований та виконаний безпосередньо, або його виконання може бути відтерміноване. Наприклад:</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
vm<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Contextify the object.</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token string">'x += 40; var y = 17;'</span><span class="token punctuation">;</span>
<span class="token comment">// `x` and `y` are global variables in the context.</span>
<span class="token comment">// Initially, x has the value 2 because that is the value of context.x.</span>
vm<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 17</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1; y is not defined.</span>

</code></pre></div><p>Код виконується в ізольованому контексті, посилання на який передається у  виклик <code>vm.runInContext</code>. Таким чином, ми можемо попередньо (до виконання коду) належним чином проиниціювати початковий стан контексту виконання.</p> <p>За основу візьмемо наш попередній проект та внесемо в нього необхідні зміни.</p> <p>Додамо файл <code>./routes/scripted-query-simple.js</code> спрощеної версії обробника запитів на виконання сценаріїв:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;vm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  
  <span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  sandbox<span class="token punctuation">.</span>axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;axios&quot;</span><span class="token punctuation">)</span>
  sandbox<span class="token punctuation">.</span>Promise <span class="token operator">=</span> Promise
  sandbox<span class="token punctuation">.</span>moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>
  sandbox<span class="token punctuation">.</span>_ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span>
  
    
  sandbox<span class="token punctuation">.</span>$scope <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scope <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>Script</span><span class="token punctuation">(</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>script <span class="token punctuation">)</span>
      <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>createContext</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span>
      script<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token string">&quot;SUCCEESS&quot;</span><span class="token punctuation">,</span>
        script<span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>script<span class="token punctuation">,</span>
        scope<span class="token operator">:</span> sandbox<span class="token punctuation">.</span>$scope
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token string">&quot;ERROR&quot;</span><span class="token punctuation">,</span>
        script<span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>script<span class="token punctuation">,</span>
        scope<span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>    
      
<span class="token punctuation">}</span>
</code></pre></div><p>Імпортуємо <code>vm</code> та визначаємо обробник, який експортується модулем. Сам обробник спочатку формує контекст виконання <code>sandbox</code>, надаючи в ньому доступ до бібліотек <code>axios</code>, <code>moment</code>, <code>lodash</code>. Потім контекст розширюється тим контекстом, що переданий в запиті (<code>req.body.scope</code>) - <code>sandbox.$scope</code>.</p> <p>Виконання скрипта заключене в блоці <code>try-catch</code>, що дозволяє контролювати статус виконання запиту, який є одним з параметрів, що включений у відповідь сервісу. Також, у випадку настання будь-якої виключної ситуації, у відповідь включене повідомлення про виключну ситуацію, що виникла.</p> <p>Внесемо зміни у файл <code>./server.js</code>:</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> sse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./middlewares/sse-p2p-buffered&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> requestDecorator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./middlewares/request-decorator&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>staticPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    parameterLimit<span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
    limit<span class="token operator">:</span> <span class="token string">'50mb'</span><span class="token punctuation">,</span>
    extended<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    limit<span class="token operator">:</span> <span class="token string">'50mb'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// app.use(&quot;/api&quot;, router)</span>

<span class="token comment">// app.use(&quot;/ping/:count&quot;, sse(), (req, res) =&gt; {</span>
  
<span class="token comment">//  if(req.headers['last-event-id']) return</span>
  
<span class="token comment">//  require(&quot;./routes/process&quot;)(req,res)  </span>
  
<span class="token comment">// })</span>


app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/eval/simple&quot;</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/scriptable-query-simple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment">// app.get(</span>
<span class="token comment">//  &quot;/log/:eventChannelID&quot;,</span>
<span class="token comment">//  requestDecorator( req =&gt; { </span>
<span class="token comment">//    req.headers.eventChannelID = req.params.eventChannelID</span>
<span class="token comment">//  }),</span>
<span class="token comment">//  sse({channelIDHeader:&quot;eventChannelID&quot;})</span>
<span class="token comment">// )</span>


<span class="token keyword">let</span> server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>port<span class="token punctuation">,</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">** EDU JACE server starts at port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> server

</code></pre></div><p>Заключаємо в коментарі тимчасово невиконуваний код та додаємо наш обробник для <code>POST</code>-запитів кінцевої
точки <code>/eval/simple</code>.</p> <p>Також створимо HTML сторінку <code>./assets/eval-simple.html</code>, яка буде імітувати веб-застосунок:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span> Scripted Query API (Simple) <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> 
    <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span> 
    <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
      padding:10px; 
      border:1px solid; 
      font-size: 14px; 
      width: fit-content;
      <span class="token punctuation">&quot;</span></span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/eval/simple&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
      method<span class="token operator">:</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> 
      headers<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json;charset=utf-8'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>script<span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$scope.output = $scope.input.split(&quot; &quot;).length</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> scope<span class="token operator">:</span><span class="token punctuation">{</span>input<span class="token operator">:</span><span class="token string">&quot;the passed input value&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span> 

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span> 

</code></pre></div><p>Визначаємо контейнер <code>&lt;pre id=&quot;container&quot;...</code> для відображення результату запиту. Виконуємо скрипт, який здійснює виклик
кінцевої точки <code>/eval/simple</code> та передає сценарій:</p> <div class="language-js extra-class"><pre class="language-js"><code>$scope<span class="token punctuation">.</span>output <span class="token operator">=</span> $scope<span class="token punctuation">.</span>input<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length
</code></pre></div><p>В цьому сценарії обчислюється кількість слів у повідомленні, яке міститься в змінній <code>input</code> вхідного контексту.</p> <p>Також в якості вхідного контексту виконання передається:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token string">&quot;the passed input value&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Після отримання результату запиту його текстове подання вбудовується в контейнер.</p> <p>Запустимо сервер та зробимо запит за адресою <a href="http://localhost:8080/eval-simple.html" target="_blank" rel="noopener noreferrer">http://localhost:8080/eval-simple.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
Отримаємо результат:</p> <center><img src="/06-01.jpg" style="width:80%;margin:1em 0;border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);"></center> <p>Якщо ми зробимо синтаксичну помилку в сценарії, наприклад:</p> <div class="language-js extra-class"><pre class="language-js"><code>$scope<span class="token punctuation">.</span>output <span class="token operator">=</span> $scope<span class="token punctuation">.</span>input<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">.</span>length
</code></pre></div><p>сервер надасть наступну відповідь:</p> <center><img src="/06-02.jpg" style="width:80%;margin:1em 0;border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);"></center> <p>У разі виникнення виключної ситуації, наприклад при виконанні коду:</p> <div class="language-js extra-class"><pre class="language-js"><code>$scope<span class="token punctuation">.</span>output <span class="token operator">=</span> $scope<span class="token punctuation">.</span>inp<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length
</code></pre></div><p>відповідь буде такою:</p> <center><img src="/06-03.jpg" style="width:80%;margin:1em 0;border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);"></center> <p>Таким чином, ми забезпечили можливість виконання javascript коду, який визначається в браузері та виконується на серверному боці в обмеженому контексті, також ми контролюємо на стороні клієнта статус виконання коду та діагностику виключних ситуацій.</p> <p>Але наш обробник буде корректно працювати лише виконучи той код, в якому відсутні виклики асинхроних операцій.</p> <h2 id="обробник-sq-запитів-з-підтримкою-асинхроних-операціи"><a href="#обробник-sq-запитів-з-підтримкою-асинхроних-операціи" class="header-anchor">#</a> Обробник SQ-запитів з підтримкою асинхроних операцій</h2> <p>Для того, щоб коректно виконувати код з використанням асинхроних операцій, необхідно відтермінувати відповідь сервера до моменту готовності результатів цих операцій. Ми будемо використовувати обертку промісу навколо виконуваного на стороні сервера коду. Оскільки неможливо автоматично визначити момент часу (стан), коли повинен бути відправлений з сервера результат, нам необхідно вбудувати в контекст виконання відповідні обробники <code>$resolve</code> та <code>$reject</code>.</p> <p>Створимо файл обробника <code>./routes/scripted-query-promise.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;vm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>isFunction<span class="token punctuation">,</span> isNull<span class="token punctuation">,</span> isUndefined<span class="token punctuation">,</span> extend <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">objToString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> ndeep</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;string&quot;</span><span class="token operator">:</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;function&quot;</span><span class="token operator">:</span> <span class="token keyword">return</span> obj<span class="token punctuation">.</span>name <span class="token operator">||</span> obj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;object&quot;</span><span class="token operator">:</span>
      <span class="token keyword">var</span> indent <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>ndeep<span class="token operator">||</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isArray <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">'{['</span><span class="token punctuation">[</span><span class="token operator">+</span>isArray<span class="token punctuation">]</span> <span class="token operator">+</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">return</span> <span class="token string">'\n\t'</span> <span class="token operator">+</span> indent <span class="token operator">+</span><span class="token punctuation">(</span>isArray<span class="token operator">?</span><span class="token string">''</span><span class="token operator">:</span> key <span class="token operator">+</span> <span class="token string">': '</span> <span class="token punctuation">)</span><span class="token operator">+</span> <span class="token function">objToString</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ndeep<span class="token operator">||</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> indent <span class="token operator">+</span> <span class="token string">'}]'</span><span class="token punctuation">[</span><span class="token operator">+</span>isArray<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\s\t\n]+(?=(?:[^\'&quot;]*[\'&quot;][^\'&quot;]*[\'&quot;])*[^\'&quot;]*$)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> obj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">let</span> console <span class="token operator">=</span> <span class="token punctuation">{</span>
    output<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">log</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span>output <span class="token operator">=</span> console<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">a</span> <span class="token operator">=&gt;</span> <span class="token function">objToString</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

      axios<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;axios&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Promise<span class="token punctuation">,</span>
      moment<span class="token operator">:</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      _<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    
      $resolve<span class="token operator">:</span> resolve<span class="token punctuation">,</span>
      $reject<span class="token operator">:</span> reject<span class="token punctuation">,</span>
      console<span class="token punctuation">,</span>
      $scope<span class="token operator">:</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scope <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>Script</span><span class="token punctuation">(</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>script <span class="token punctuation">)</span>
        <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>createContext</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span>
        script<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token string">&quot;SUCCEESS&quot;</span><span class="token punctuation">,</span>
        scope<span class="token operator">:</span> result<span class="token punctuation">,</span>
        <span class="token constant">STDOUT</span><span class="token operator">:</span> console<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>  
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token string">&quot;ERROR&quot;</span><span class="token punctuation">,</span>
        scope<span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token constant">STDOUT</span><span class="token operator">:</span> console<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>  
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 

</code></pre></div><p>Функція <code>objToString</code> виконує серіалізацію у вигляді тексту об'єктів javascript та використовується у перевизначенні
<code>console</code>, яке вбудовується в контекст виконання. Тобто, використання <code>console.log(...)</code> замість виводу в термінал
буде накопичувати буфер, який в якості <code>STDOUT</code> буде переданий клієнту у відповіді. Таким способом ми реалізуємо засоби відлагодження скрипта.</p> <p>Саме виконання скрипта обернуто в проміс:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// виконання скрипта </span>
  
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// відповідь, якщо все добре    </span>
  
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// відповідь, якщо виникла виключна ситуація  </span>
  
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>Функції управління оберткою та перезавантажена <code>console</code> вбудовуються в контекст виконання:</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

      <span class="token operator">...</span>
      $resolve<span class="token operator">:</span> resolve<span class="token punctuation">,</span>
      $reject<span class="token operator">:</span> reject<span class="token punctuation">,</span>
      console<span class="token punctuation">,</span>
      <span class="token operator">...</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>Все інше відбувається майже так само, як і в попередньому обробнику.</p> <p>В файлі <code>./server.js</code> внесемо необхідні зміни:</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> sse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./middlewares/sse-p2p-buffered&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> requestDecorator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./middlewares/request-decorator&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>staticPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    parameterLimit<span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
    limit<span class="token operator">:</span> <span class="token string">'50mb'</span><span class="token punctuation">,</span>
    extended<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    limit<span class="token operator">:</span> <span class="token string">'50mb'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/eval/simple&quot;</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/scriptable-query-simple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/eval/promise&quot;</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/scriptable-query-promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment">// app.get(</span>
<span class="token comment">//  &quot;/log/:eventChannelID&quot;,</span>
<span class="token comment">//  requestDecorator( req =&gt; { </span>
<span class="token comment">//    req.headers.eventChannelID = req.params.eventChannelID</span>
<span class="token comment">//  }),</span>
<span class="token comment">//  sse({channelIDHeader:&quot;eventChannelID&quot;})</span>
<span class="token comment">// )</span>


<span class="token keyword">let</span> server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>port<span class="token punctuation">,</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">** EDU JACE server starts at port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> server

</code></pre></div><p>Як бачимо, розроблений нами обробник, - прив'язаний до кінцевої точки <code>/eval/promise</code></p> <p>Створимо HTML-сторінку <code>./assets/eval-promise.html</code>для імітації виклику цієї кінцевої точки з веб-застосунку:</p> <div class="language-html extra-class"><pre class="language-html"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span> Scripted Query API (Promise) <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>STATUS: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span> #01579b<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span> 0.25em<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>SCOPE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> 
    <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scope<span class="token punctuation">&quot;</span></span> 
    <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
      padding:10px; 
      border:1px solid; 
      font-size: 14px; 
      width: 80%;
      overflow:auto;
        <span class="token punctuation">&quot;</span></span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>STDOUT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> 
    <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stdout<span class="token punctuation">&quot;</span></span> 
    <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
      padding:10px; 
      border:1px solid; 
      width: 80%;
      overflow:auto;
        <span class="token punctuation">&quot;</span></span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>



  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    
    <span class="token keyword">let</span> scriptableQuery <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      axios
        .get(&quot;http://localhost:8080/api/presidents&quot;)
        .then( res =&gt; {
          console.log(&quot;Get data from db&quot;, res.data.map( d =&gt; d.name))
          return Promise.all(res.data.map(p =&gt; 
          axios.get(&quot;http://en.wikipedia.org/w/api.php?origin=*&amp;action=query&amp;format=json&amp;prop=description%7Cextracts%7Cpageimages%7Crevisions&amp;redirects=1&amp;formatversion=2&amp;exsentences=2&amp;exintro=1&amp;explaintext=1&amp;piprop=thumbnail&amp;pithumbsize=300&amp;rvprop=timestamp&quot;
                +&quot;&amp;titles=&quot;+p.name.split(&quot; &quot;).join(&quot;+&quot;)
          )
            .then( wikiRes =&gt; {
              console.log(&quot;FETCH WIKIDATA FOR&quot;, p.name)
              p.description = wikiRes.data.query.pages[0].description
              p.extract = wikiRes.data.query.pages[0].extract
              // p.wikiresp = wikiresp.data
              return p
            })
            //.catch(e =&gt; {
            //    $reject(e)
            //})
        ))})
        .then( res =&gt; {
          console.log(&quot;All data processed&quot;)
          $resolve(res)
        })
        .catch(e =&gt; {
          console.log(&quot;Ups! Reject!&quot;)
          $reject(e)
        })
      </span><span class="token template-punctuation string">`</span></span>

      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/eval/promise&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        method<span class="token operator">:</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> 
        headers<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json;charset=utf-8'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>script<span class="token operator">:</span>scriptableQuery<span class="token punctuation">}</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
          document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> r<span class="token punctuation">.</span>status
          document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;scope&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>scope<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
          document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;stdout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token constant">STDOUT</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span> 

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p>Визначаємо різні контейнери для значень статусу, контексту та буфера виводу та виконуємо SQ-запит.</p> <p>Сам сценарій оброблення даних:</p> <div class="language-js extra-class"><pre class="language-js"><code>axios
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/api/presidents&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Get data from db&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">d</span> <span class="token operator">=&gt;</span> d<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> 
          axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://en.wikipedia.org/w/api.php?origin=*&amp;action=query&amp;format=json&amp;prop=description%7Cextracts%7Cpageimages%7Crevisions&amp;redirects=1&amp;formatversion=2&amp;exsentences=2&amp;exintro=1&amp;explaintext=1&amp;piprop=thumbnail&amp;pithumbsize=300&amp;rvprop=timestamp&quot;</span>
                <span class="token operator">+</span><span class="token string">&quot;&amp;titles=&quot;</span><span class="token operator">+</span>p<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;+&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">wikiRes</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;FETCH WIKIDATA FOR&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
              p<span class="token punctuation">.</span>description <span class="token operator">=</span> wikiRes<span class="token punctuation">.</span>data<span class="token punctuation">.</span>query<span class="token punctuation">.</span>pages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>description
              p<span class="token punctuation">.</span>extract <span class="token operator">=</span> wikiRes<span class="token punctuation">.</span>data<span class="token punctuation">.</span>query<span class="token punctuation">.</span>pages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>extract
              <span class="token keyword">return</span> p
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">$reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;All data processed&quot;</span><span class="token punctuation">)</span>
          <span class="token function">$resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Ups! Reject!&quot;</span><span class="token punctuation">)</span>
          <span class="token function">$reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>здійснює виклик власного API <code>/api/presidents</code> (асинхронна операція). Отримавши колекцію даних, для кожного
елемента здійснюємо запит до API вікіпедії; потім &quot;збагачуємо&quot;  кожен елемент вибраними з вікіпедії даними (асинхронні дії, що виконуються паралельно). Коли всі ці дії завершуються, ініціюємо закінчення роботи для обертки <code>$resolve</code>. Сценарій також містить команди консольного виводу для відлагодження роботи.</p> <p>Якщо перезапустити сервер та здійснити запит за адресою <a href="http://localhost:8080/eval-promise.html" target="_blank" rel="noopener noreferrer">http://localhost:8080/eval-promise.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, отримаємо результат:</p> <center><img src="/06-04.jpg" style="width:95%;margin:0.5em 0;border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);"></center> <p>Якщо відключити доступ до мережі та перезавантажити сторінку, отримаємо:</p> <center><img src="/06-05.jpg" style="width:80%;margin:0.5em 0;border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);"></center> <p>Таким чином, нова версія обробника вирішує всі необхідні завдання: потужна мова сценаріїв, підтримка асинхронних операцій, обмежений контекст виконання, контроль статусу запитів, наявність засобів відлагодження.</p> <p>Однак, все оброблення даних здійснюється в межах виконання одного запиту. Час на виконання запиту може перевищити обмеження для сервера. Тобто існує певне обмеження на складність(час виконання сценаріїв).</p> <p>Для того, щоб позбутися цього обмеження, необхідно декомпозувати складний сценарій на послідовність більш простих з можливістю доставки результатів  виконання окремих частин складного сценарію.</p> <h2 id="обробник-sq-запитів-з-підтримкою-sse"><a href="#обробник-sq-запитів-з-підтримкою-sse" class="header-anchor">#</a> Обробник SQ-запитів з підтримкою SSE</h2> <p>Подібне завдання (інкрементна реалізація оброблення запиту) ми вирішували в попередньому проекті. Використаємо ці напрацювання.</p> <p>Створимо файл нового обробника <code>./routes/sqripted-query-sse.js</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;vm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>isFunction<span class="token punctuation">,</span> isNull<span class="token punctuation">,</span> isUndefined<span class="token punctuation">,</span> extend <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">objToString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> ndeep</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;string&quot;</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>obj<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;function&quot;</span><span class="token operator">:</span> <span class="token keyword">return</span> obj<span class="token punctuation">.</span>name <span class="token operator">||</span> obj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;object&quot;</span><span class="token operator">:</span>
      <span class="token keyword">var</span> indent <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>ndeep<span class="token operator">||</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isArray <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">'{['</span><span class="token punctuation">[</span><span class="token operator">+</span>isArray<span class="token punctuation">]</span> <span class="token operator">+</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">return</span> <span class="token string">'\n\t'</span> <span class="token operator">+</span> indent <span class="token operator">+</span><span class="token punctuation">(</span>isArray<span class="token operator">?</span><span class="token string">''</span><span class="token operator">:</span> key <span class="token operator">+</span> <span class="token string">': '</span> <span class="token punctuation">)</span><span class="token operator">+</span> <span class="token function">objToString</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ndeep<span class="token operator">||</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> indent <span class="token operator">+</span> <span class="token string">'}]'</span><span class="token punctuation">[</span><span class="token operator">+</span>isArray<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\s\t\n]+(?=(?:[^\'&quot;]*[\'&quot;][^\'&quot;]*[\'&quot;])*[^\'&quot;]*$)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> obj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  
  
  <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> console <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">log</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> data <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">a</span> <span class="token operator">=&gt;</span> <span class="token function">objToString</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span>sse<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          event<span class="token operator">:</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span>
          data 
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    
    
    <span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

      axios<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;axios&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Promise<span class="token punctuation">,</span>
      moment<span class="token operator">:</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      _<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    
      <span class="token function-variable function">$resolve</span><span class="token operator">:</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>sse<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">&quot;resolve&quot;</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">$reject</span><span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>sse<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">&quot;reject&quot;</span><span class="token punctuation">,</span> data<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">$close</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>sse<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

      console<span class="token punctuation">,</span>
      $scope<span class="token operator">:</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scope <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

      
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>Script</span><span class="token punctuation">(</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>script <span class="token punctuation">)</span>
        <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>createContext</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span>
      script<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sandbox<span class="token punctuation">.</span><span class="token function">$reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
  
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:8080/log/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>sse<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> 
  
<span class="token punctuation">}</span> 

</code></pre></div><p>Ми плануємо використовувати підтримку SSE у вигляді <code>middleware</code>, яку ми розробили в попередньому проекті.</p> <p>Оброблення запиту полягає у сповіщені кліента про кінцеву точку каналу повідомлень SSE та асинхронному запуску процесу виконання скрипта.</p> <p>Для того, щоб частково зберегти сумісність з попереднім обробником, засоби доставки повідомлень вбудуємо в контекст виконання як
<code>$resolve</code>, <code>$reject</code>, <code>$close</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>    
      
      <span class="token function-variable function">$resolve</span><span class="token operator">:</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>sse<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">&quot;resolve&quot;</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">$reject</span><span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>sse<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> event<span class="token operator">:</span> <span class="token string">&quot;reject&quot;</span><span class="token punctuation">,</span> data<span class="token operator">:</span> error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">$close</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>sse<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

      <span class="token operator">...</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>


</code></pre></div><p>Тепер операції <code>$resolve</code> та <code>$reject</code> можуть використовуватися в сценарії багаторазово, їх реалізовано як передачу повідомлень відповідного типу через <code>res.sse</code>. По закінченню виконання сценарію необхідно закрити канал, тому вбудована функція  <code>$close</code>.</p> <p>Використовується ещо інша реалізація для <code>console</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> console <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">log</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> data <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">a</span> <span class="token operator">=&gt;</span> <span class="token function">objToString</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span>sse<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          event<span class="token operator">:</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span>
          data 
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Замість накопичення буфера виводу ми безпосередньо передаємо повідомлення через <code>res.sse</code>.</p> <p>Треба внести зміни до файлу <code>./server.js</code>:</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> sse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./middlewares/sse-p2p-buffered&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> requestDecorator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./middlewares/request-decorator&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>staticPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    parameterLimit<span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
    limit<span class="token operator">:</span> <span class="token string">'50mb'</span><span class="token punctuation">,</span>
    extended<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    limit<span class="token operator">:</span> <span class="token string">'50mb'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>



app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/eval/simple&quot;</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/scriptable-query-simple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/eval/promise&quot;</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/scriptable-query-promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/eval/sse&quot;</span><span class="token punctuation">,</span> <span class="token function">sse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>noResponse<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/scripted-query-sse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/log/:eventChannelID&quot;</span><span class="token punctuation">,</span>
  <span class="token function">requestDecorator</span><span class="token punctuation">(</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
    req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>eventChannelID <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>eventChannelID
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">sse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>channelIDHeader<span class="token operator">:</span><span class="token string">&quot;eventChannelID&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>


<span class="token keyword">let</span> server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>port<span class="token punctuation">,</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">** EDU JACE server starts at port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> server

</code></pre></div><p>Визначаємо кінцеву точку <code>/eval/sse</code> та підключаємо обробник через middleware <code>sse</code>.</p> <p>Створимо HTML-сторінку <code>./assets/eval-sse.html</code> для перевірки працездатності нашого сервера:</p> <div class="language-html extra-class"><pre class="language-html"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span> Scripted Query API (SSE) <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>SSE CHANELL: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>channel<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> 
    <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status<span class="token punctuation">&quot;</span></span> 
    <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
      padding:10px; 
      border:1px solid; 
      font-size: 14px; 
      width: 80%;
      overflow:auto;
        <span class="token punctuation">&quot;</span></span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>SCOPE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> 
    <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scope<span class="token punctuation">&quot;</span></span> 
    <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
      padding:10px; 
      border:1px solid; 
      font-size: 14px; 
      width: 80%;
      overflow:auto;
        <span class="token punctuation">&quot;</span></span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>STDOUT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span> 
    <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stdout<span class="token punctuation">&quot;</span></span> 
    <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
      padding:10px; 
      border:1px solid; 
      width: 80%;
      overflow:auto;
        <span class="token punctuation">&quot;</span></span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>



  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    
    <span class="token keyword">let</span> scriptableQuery <span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> 
  axios
    .get(&quot;http://localhost:8080/api/presidents&quot;)
    .then( res =&gt; {
      console.log(&quot;Get data from db&quot;, res.data.map(d =&gt; d.name))
      return Promise.all(res.data.map(p =&gt; 
      axios.get(&quot;http://en.wikipedia.org/w/api.php?origin=*&amp;action=query&amp;format=json&amp;prop=description%7Cextracts%7Cpageimages%7Crevisions&amp;redirects=1&amp;formatversion=2&amp;exsentences=2&amp;exintro=1&amp;explaintext=1&amp;piprop=thumbnail&amp;pithumbsize=300&amp;rvprop=timestamp&quot;
            +&quot;&amp;titles=&quot;+p.name.split(&quot; &quot;).join(&quot;+&quot;)
      )
        .then( wikiRes =&gt; {
          console.log(&quot;WIKIDATA for &quot;, p.name)
          p.description = wikiRes.data.query.pages[0].description
          p.extract = wikiRes.data.query.pages[0].extract
          $resolve(p)
        })
        //.catch(e =&gt; {
        //    $reject(e)
        //})
    ))})
    .then( res =&gt; {
      console.log(&quot;All data processed&quot;)
      $close()
    })
    .catch(e =&gt; {
      $reject(e)
      $close()
    })
</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">let</span> views <span class="token operator">=</span> <span class="token punctuation">{</span>
  channel<span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  status<span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  scope<span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;scope&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  stdout<span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;stdout&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token function-variable function">print</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">slot<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  views<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>



<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/eval/sse&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> 
  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json;charset=utf-8'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>script<span class="token operator">:</span>scriptableQuery<span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
    
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;channel&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
    
    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>

    source<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;OPEN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token number">0</span><span class="token operator">:</span> <span class="token string">&quot;RECONNECT...&quot;</span><span class="token punctuation">,</span>
      <span class="token number">2</span><span class="token operator">:</span> <span class="token string">&quot;CLOSE&quot;</span>
    <span class="token punctuation">}</span>

    source<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> s <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;ERROR&quot;</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    source<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;stdout&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    source<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;resolve&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;scope&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    source<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;reject&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;scope&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 


  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span> 

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p>Сценарій, що виконується на серверному боці - такий самий, як і в попередньому прикладі.</p> <p>Після перезапуску сервера і доступу за адресою <a href="http://localhost:8080/eval-sse.html" target="_blank" rel="noopener noreferrer">http://localhost:8080/eval-sse.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, отримаємо наступне:</p> <center><img src="/06-06.jpg" style="width:95%;margin:0.5em 0;border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);"></center> <p>У випадку виникнення виключних ситуацій буде мати:</p> <center><img src="/06-07.jpg" style="width:95%;margin:0.5em 0;border-radius:4px;border:1px solid #cfd7e6;box-shadow:0 1px 3px 0 rgba(89,105,129,.05), 0 1px 1px 0 rgba(0,0,0,.025);"></center></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/boldak/dis-edu/edit/master/docs/components-interaction/06.scripted-query.md" target="_blank" rel="noopener noreferrer">Ви можете покращити цю сторінку</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/25/2021, 11:36:11 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/components-interaction/05.sse.html" class="prev">
        Push-нотифікація з використанням Server-Sent Events
      </a></span> <span class="next"><a href="/docs/swagger/12.api.html">
        Специфікація API
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/docs/assets/js/app.6573e971.js" defer></script><script src="/docs/assets/js/2.43c74522.js" defer></script><script src="/docs/assets/js/21.19f4d8a1.js" defer></script>
  </body>
</html>
