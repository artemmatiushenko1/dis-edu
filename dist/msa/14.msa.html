<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Реалізація шаблонів мікросервісної архітектури | Розподілені інформаційні системи</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/docs/faviconCustom.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="description" content="Курс лекцій">
    
    <link rel="preload" href="/docs/assets/css/0.styles.f5591410.css" as="style"><link rel="preload" href="/docs/assets/js/app.6573e971.js" as="script"><link rel="preload" href="/docs/assets/js/2.43c74522.js" as="script"><link rel="preload" href="/docs/assets/js/33.43c31432.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.ae09fb39.js"><link rel="prefetch" href="/docs/assets/js/11.a892532e.js"><link rel="prefetch" href="/docs/assets/js/12.502d8f9b.js"><link rel="prefetch" href="/docs/assets/js/13.19ba463b.js"><link rel="prefetch" href="/docs/assets/js/14.b9bc508f.js"><link rel="prefetch" href="/docs/assets/js/15.8378044f.js"><link rel="prefetch" href="/docs/assets/js/16.c5ab21e3.js"><link rel="prefetch" href="/docs/assets/js/17.056e16ea.js"><link rel="prefetch" href="/docs/assets/js/18.d77e96ca.js"><link rel="prefetch" href="/docs/assets/js/19.b664be5a.js"><link rel="prefetch" href="/docs/assets/js/20.d99a3a28.js"><link rel="prefetch" href="/docs/assets/js/21.19f4d8a1.js"><link rel="prefetch" href="/docs/assets/js/22.c12e4cd6.js"><link rel="prefetch" href="/docs/assets/js/23.cea9fca9.js"><link rel="prefetch" href="/docs/assets/js/24.03b428d0.js"><link rel="prefetch" href="/docs/assets/js/25.1189308b.js"><link rel="prefetch" href="/docs/assets/js/26.73a0e546.js"><link rel="prefetch" href="/docs/assets/js/27.94f39345.js"><link rel="prefetch" href="/docs/assets/js/28.a6b74891.js"><link rel="prefetch" href="/docs/assets/js/29.0d739a8d.js"><link rel="prefetch" href="/docs/assets/js/3.418ab320.js"><link rel="prefetch" href="/docs/assets/js/30.d3e49c4f.js"><link rel="prefetch" href="/docs/assets/js/31.5a79ea41.js"><link rel="prefetch" href="/docs/assets/js/32.892f4cee.js"><link rel="prefetch" href="/docs/assets/js/34.aa8b7542.js"><link rel="prefetch" href="/docs/assets/js/35.106db34a.js"><link rel="prefetch" href="/docs/assets/js/36.decaa943.js"><link rel="prefetch" href="/docs/assets/js/37.35adf566.js"><link rel="prefetch" href="/docs/assets/js/38.b395a8e9.js"><link rel="prefetch" href="/docs/assets/js/4.f33b38e3.js"><link rel="prefetch" href="/docs/assets/js/5.335a55c0.js"><link rel="prefetch" href="/docs/assets/js/6.98f769b8.js"><link rel="prefetch" href="/docs/assets/js/7.eaf79c7b.js"><link rel="prefetch" href="/docs/assets/js/8.721b5dad.js"><link rel="prefetch" href="/docs/assets/js/9.e42fd085.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.f5591410.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">Розподілені інформаційні системи</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div> <a href="https://github.com/boldak/dis-edu" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div> <a href="https://github.com/boldak/dis-edu" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/docs/intro/" class="sidebar-heading clickable"><span>Вступ</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/arch/" class="sidebar-heading clickable"><span>Архітетура розподілених інформаційних систем</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/components-interaction/" class="sidebar-heading clickable"><span>Реалізація взаємодії компонентів розподіленої інформаційної системи</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/swagger/" class="sidebar-heading clickable"><span>Прикладний програмний інтерфейс сервісів</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/eda/" class="sidebar-heading clickable"><span>Реалізація взаємодії компонентів в EDA</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/docs/msa/" class="sidebar-heading clickable router-link-active open"><span>Реалізація взаємодії сервісів в MSA</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/msa/14.msa.html" aria-current="page" class="active sidebar-link">Реалізація шаблонів мікросервісної архітектури</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/msa/14.msa.html#реалізація-поступовоі-деградування-сервісу" class="sidebar-link">Реалізація поступової деградування сервісу</a></li><li class="sidebar-sub-header"><a href="/docs/msa/14.msa.html#реалізація-оркестрування-саг" class="sidebar-link">Реалізація оркестрування саг</a></li><li class="sidebar-sub-header"><a href="/docs/msa/14.msa.html#реалізація-хореографіі-саг" class="sidebar-link">Реалізація хореографії саг</a></li><li class="sidebar-sub-header"><a href="/docs/msa/14.msa.html#реалізація-вимикача-сервісів" class="sidebar-link">Реалізація вимикача сервісів</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="реалізація-шаблонів-мікросервісноі-архітектури"><a href="#реалізація-шаблонів-мікросервісноі-архітектури" class="header-anchor">#</a> Реалізація шаблонів мікросервісної архітектури</h1> <p>Архітектура мікросервісів переміщує логіку додатків до служб і використовує мережевий рівень для зв'язку між ними. Спілкування через мережу замість викликів у пам'яті додає системі додаткову затримку та складність, що вимагає співпраці між кількома фізичними та логічними компонентами. Зростання складності розподіленої системи призводить до більшої ймовірності певних збоїв мережі.</p> <p>Однією з найбільших переваг архітектури мікросервісів перед монолітною є те, що команди розробників можуть самостійно проектувати, розробляти та впроваджувати свої сервіси. Вони мають повне право власності на життєвий цикл своєї служби. Це також означає, що команди не мають контролю над своїми сервісними залежностями, оскільки, швидше за все, ними керує інша команда. З архітектурою мікросервісів нам потрібно мати на увазі, що послуги провайдера можуть бути тимчасово недоступними через зламані випуски, конфігурації та інші зміни, оскільки вони контролюються кимось іншим, а компоненти переміщуються незалежно один від одного.</p> <h2 id="реалізація-поступовоі-деградування-сервісу"><a href="#реалізація-поступовоі-деградування-сервісу" class="header-anchor">#</a> Реалізація поступової деградування сервісу</h2> <p>Однією з найкращих переваг архітектури мікросервісів є те, що ви можете ізолювати збої та досягти поступової деградації сервісу, оскільки компоненти виходять з ладу окремо. Наприклад, під час відключення клієнти у програмі обміну фотографіями, можливо, не можуть завантажити нове зображення, але вони все одно можуть переглядати, редагувати та ділитися своїми наявними фотографіями.</p> <p>Спробуємо реалізувати таку властивість системи з мікросервісною архітектурою.</p> <p>Розробимо три мікросервіса, які виконують деякі дії, та спеціальний мікросервіс, що слідкує за готовністю відомих йому мікросервісів в системі.</p> <p>Для цього будемо використовувати бібліотеку <a href="https://www.npmjs.com/package/micromq" target="_blank" rel="noopener noreferrer">microMQ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, яка надає реалізацію механізму RPC з використанням брокера повідомлень RabbitMQ. Також ця бібліотека надає каркас мікросервіса, що спрощує
його створення. Цей каркас можна використовувати для реалізації як RESTfull інтерфейсів, так і для підтримки RPC.</p> <p>Крім того, бібліотека надає каркас API Gateway, яким зручно користатися для поступового переходу від монолітної архітектури системи до мікросервісної.</p> <p>Створимо новий проект та встановимо необхідні залежності. При цьому файл <code>./package.json</code> має вигляд</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;msa-gsd&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MSA features&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node server&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon server&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;amqplib&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.8.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;axios&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.21.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;body-parser&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.19.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;cookie-parser&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.4.5&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;express&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.17.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lodash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.17.21&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;micromq&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;moment&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.29.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.3.2&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nodemon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.9&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>Створимо файл конфігурації <code>./config.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    server<span class="token operator">:</span><span class="token punctuation">{</span>
        port<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">8082</span><span class="token punctuation">,</span>
        staticPath<span class="token operator">:</span> <span class="token string">&quot;./assets&quot;</span><span class="token punctuation">,</span>
        routes<span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token string">&quot;/s1/health&quot;</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;ms1&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token string">&quot;/s2/health&quot;</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;ms2&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token string">&quot;/s3/health&quot;</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;ms3&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    apiGateway<span class="token operator">:</span><span class="token punctuation">{</span>
        microservices<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;ms1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ms2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ms3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        rabbit<span class="token operator">:</span> <span class="token punctuation">{</span>
            url<span class="token operator">:</span> <span class="token string">'&lt;your RabbitMQ url connection&gt;'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Також створимо файл <code>server.js</code>, фасаду нашого сервісу на основі express</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Gateway <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'micromq/gateway'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> extend <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;axios&quot;</span><span class="token punctuation">)</span>
axios<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>baseURL <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8080&quot;</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> gateway <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gateway</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>staticPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    parameterLimit<span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
    limit<span class="token operator">:</span> <span class="token string">'50mb'</span><span class="token punctuation">,</span>
    extended<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    limit<span class="token operator">:</span> <span class="token string">'50mb'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>gateway<span class="token punctuation">.</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">[</span>route<span class="token punctuation">.</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> route<span class="token punctuation">.</span>handler<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/health&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token parameter">req<span class="token punctuation">,</span> res</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span> config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

            <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                method<span class="token operator">:</span> ms<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
                url<span class="token operator">:</span> ms<span class="token punctuation">.</span>path
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">resp</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;available&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;failed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>  
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>port<span class="token punctuation">,</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">** EDU JACE server starts at port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>


</code></pre></div><p>Шлюз API <code>Gateway</code> з бібліотеки micromq надає middleware, яке забезпечує можливість делегувати оброблення запитів мікросервісам з використанням RPC. Налаштування шлюзу береться з config.apiGateway( необхідно вказати  для доступу до брокера повідомлень, а також імена мікросервісів, яким буде делеговане оброблення запитів).</p> <p>Middleware додає до <code>res`` метод делегування запитів</code>res.delegate<code>, який ми використовуємо в конфігурації (</code>config.routes```). Ця маршрутизація запитів під'єднується при ініціалізації нашого сервера.</p> <p>Обробник маршруту  <code>/health</code> для кожного мікросервісу здійснює виклик через фасад нашого сервісу, наприклад
<a href="http://localhost:8080/ms1/health" target="_blank" rel="noopener noreferrer">http://localhost:8080/ms1/health<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, та збирає разом результати перевірки готовності сервісів.</p> <p>Наступним кроком є розроблення сервісів (файли <code>./services/ms1.js</code>, <code>./services/ms2.js</code>, <code>./services/ms3.js</code>) відрізняються лише назвою мікросервісу)</p> <div class="language-js extra-class"><pre class="language-js"><code>

<span class="token keyword">const</span> MicroMQ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'micromq'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> instanceId <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../config&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MicroMQ</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ms1'</span><span class="token punctuation">,</span>
  rabbit<span class="token operator">:</span> config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>rabbit
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/s1/health'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>instanceId<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>  

app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ms1 instance </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>instanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> started</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>       
    <span class="token punctuation">}</span><span class="token punctuation">)</span>


</code></pre></div><p>Ми використовуємо каркас мікросервісу <code>app</code>, який налаштовується майже так само, як шлюз API.</p> <p>Визначаємо обробник маршруту (схоже на визначення обробника маршруту в ), проте реалізація методів використовує
черги повідомлень для віддалених викликів та відповідей. Ці черги є персистентними, тому, якщо один з сервісів
виходить з ладу, повідомлення в його черзі викликів накопичуються. Таким чином реалізується гарантоване доставлення
повідомлень.</p> <p>Перевіримо, яким чином працює делегування фасадом запитів від  до мікросервісів.</p> <p>Запустимо сервер (npm start) та три мікросервіси (команди майже однакові <code>node ./services/ms1(ms2)(ms3)</code>).
Після звертання за адресою <a href="http://localhost:8080/health" target="_blank" rel="noopener noreferrer">http://localhost:8080/health<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> отримаємо результат</p> <div class="language-json extra-class"><pre class="language-json"><code>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2561095c-6bb7-48d6-b6cd-a11fd606a54f&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s1/health&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;48ea82ef-32f9-409b-a686-0f7f6b54a7e6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s2/health&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;50368676-3eb1-4cc1-a966-c7b790c0705d&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s3/health&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</code></pre></div><p>Таким чином, бачимо, що делегування працює.</p> <p>Тепер вимикнемо мікросервіс <code>ms1</code> та перезавантажимо сторінку</p> <div class="language-json extra-class"><pre class="language-json"><code>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;failed&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s1/health&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;48ea82ef-32f9-409b-a686-0f7f6b54a7e6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s2/health&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;50368676-3eb1-4cc1-a966-c7b790c0705d&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s3/health&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</code></pre></div><p>Маємо поступове деградування сервісу: функціональність  <code>ms1</code> недоступна, проте <code>ms2</code> та <code>ms3</code> працюють.</p> <p>Оскільки реалізована в бібліотеці схема  забезпечує чергу завдань(викликів), можна легко масштабувати мікросервіси.
Для перевірки цього треба запустити два екземпляри сервісу <code>ms1</code> та декілька разів оновити сторінку.</p> <div class="language-json extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-json"><code>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0b820fbe-7ef5-4bc9-850f-2d9492b256b6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s1/health&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;48ea82ef-32f9-409b-a686-0f7f6b54a7e6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s2/health&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;50368676-3eb1-4cc1-a966-c7b790c0705d&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s3/health&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><div class="language-json extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-json"><code>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;adb56dfc-d60c-49ab-ba28-3d660024d656&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s1/health&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;48ea82ef-32f9-409b-a686-0f7f6b54a7e6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s2/health&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;50368676-3eb1-4cc1-a966-c7b790c0705d&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/s3/health&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</code></pre></div><p>Бачимо, що виклики розподіляються між двома екземплярами сервісу <code>ms1</code>.</p> <p>Таким чином, ми реалізували поступову деградування сервісу, можливість його повного відновлення та можливість масштабування.</p> <h2 id="реалізація-оркестрування-саг"><a href="#реалізація-оркестрування-саг" class="header-anchor">#</a> Реалізація оркестрування саг</h2> <p>Нагадаємо, що сага - це розподілена транзакція, яка складається з послідовності так званих локальних транзакцій в задіяних мікросервісах. Оркестрація саги передбачає, що створюється спеціальний об'єкт-оркестратор, який ініціює локальні транзакції, оброблює іх результати та приймає рішення про успішне завершення саги.</p> <p>Використання механізму RPC дозволяє успішно здійснювати оркестрування саг.</p> <p>Наш оркестратор буде реалізований, як окремий мікросервіс та буде здійснювати оркестрування саги виявлення готовності ресурсів нашої системи.</p> <p>Створимо файл <code>./services/system-health.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>

<span class="token keyword">const</span> MicroMQ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'micromq'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> instanceId <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> extend <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MicroMQ</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'system-health'</span><span class="token punctuation">,</span>
  microservices<span class="token operator">:</span>config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>microservices<span class="token punctuation">,</span>
  rabbit<span class="token operator">:</span> config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>rabbit
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getSystemHealth</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">rpcPattern</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>

    config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>microservices<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            
        <span class="token keyword">let</span> timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;failed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>service<span class="token operator">:</span>ms<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>    
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

        app<span class="token punctuation">.</span><span class="token function">ask</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> rpcPattern<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">resp</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;available&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resp<span class="token punctuation">,</span><span class="token punctuation">{</span>service<span class="token operator">:</span>ms<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;failed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>service<span class="token operator">:</span>ms<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/health/act'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getSystemHealth</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    server<span class="token operator">:</span><span class="token punctuation">{</span>
        action<span class="token operator">:</span><span class="token string">&quot;get_health&quot;</span><span class="token punctuation">,</span>
        meta<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/health/req'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getSystemHealth</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> <span class="token string">&quot;/health&quot;</span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/health'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>instanceId<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>  

app<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">'get_health'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">meta<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>instanceId<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>  


app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">system-health instance </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>instanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> started</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>     
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>Ми використовуємо каркас, визначаємо обробники маршрутів</p> <ul><li><code>/health/act</code> - для використання виклику дій на стороні мікросервісів;</li> <li><code>/health/req</code> - для використання виклику за маршрутами;</li> <li><code>/health</code> - для відповіді про готовність самого сервісу.</li></ul> <p>Також ми визначаємо команду(дію)  <code>get_health</code>, яка відповідає про готовність самого сервісу. Ми плануємо отримувати зведення про готовність всіх ресурсів(включаючи власне <code>system-health</code>).</p> <p>Сам оркестратор інкапсульовано в функції <code>getSystemHealth</code>, яка здійснює опитування мікросервісів за допомогою
<code>app.ask(ms, rpcPattern)</code>. Виклики дій або маршрутів визначаються змістом <code>rpcPattern</code>.</p> <p><code>app.ask</code> передає виклик в чергу викликів сервісу <code>ms</code> та очікує відповідного повідомлення в черзі відповідей. У разі, коли сервіс не відповідає, будемо мати &quot;зависання&quot; оброблення запиту. Тому ми використовуємо таймаут з максимальним часом очікування відповіді. Коли він закінчується ми приймаємо рішення про неготовність сервісу <code>ms</code>.</p> <p>Внесемо зміни до конфігураційного файлу</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    server<span class="token operator">:</span><span class="token punctuation">{</span>
        port<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">8080</span><span class="token punctuation">,</span>
        staticPath<span class="token operator">:</span> <span class="token string">&quot;./assets&quot;</span><span class="token punctuation">,</span>
        routes<span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/health/act&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/health/req&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;system-health&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token string">&quot;/s1/health&quot;</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
                    <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;ms1&quot;</span><span class="token punctuation">)</span> 
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token string">&quot;/s2/health&quot;</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;ms2&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token string">&quot;/s3/health&quot;</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;ms3&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    apiGateway<span class="token operator">:</span><span class="token punctuation">{</span>
        microservices<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;ms1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ms2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ms3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;system-health&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        rabbit<span class="token operator">:</span> <span class="token punctuation">{</span>
            url<span class="token operator">:</span> <span class="token string">'&lt;your RabbitMQ url connection&gt;'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Ми визначаємо делегування на сервіс <code>system-health</code>.</p> <p>Потрібні зміни і в наших мікросервісах</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> MicroMQ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'micromq'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> instanceId <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../config&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MicroMQ</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ms1'</span><span class="token punctuation">,</span>
  rabbit<span class="token operator">:</span> config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>rabbit
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/s1/health'</span><span class="token punctuation">,</span><span class="token string">'/health'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>instanceId<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>  


app<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">'get_health'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">meta<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>instanceId<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>  


app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ms1 instance </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>instanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> started</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>       
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>Ми додаємо маршрут та дію, які будуть використовуватись нашим оркестратором.</p> <p>Перезапустимо фасад, три мікросервіси та <code>system-health</code>, потім завантажимо сторінку
<a href="http://localhost:8080/health/act" target="_blank" rel="noopener noreferrer">http://localhost:8080/health/act<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Будемо мати</p> <div class="language-json extra-class"><pre class="language-json"><code>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token property">&quot;response&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;e825a806-ed8d-47d6-b7c4-67680aa1b180&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ms1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;failed&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ms2&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;failed&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ms3&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token property">&quot;response&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1b6dd70e-6363-4c10-848a-bd7ee0f58a97&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system-health&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</code></pre></div><p>Після завантаження <a href="http://localhost:8080/health/req" target="_blank" rel="noopener noreferrer">http://localhost:8080/health/req<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> маємо</p> <div class="language-json extra-class"><pre class="language-json"><code>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token property">&quot;response&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;e825a806-ed8d-47d6-b7c4-67680aa1b180&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ms1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;failed&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ms2&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;failed&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ms3&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token property">&quot;response&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1b6dd70e-6363-4c10-848a-bd7ee0f58a97&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system-health&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</code></pre></div><p>Отже, оркестрація саг може бути реалізована за допомогою RPC. Бібліотека micromq надає декілька способів його використання, а також надає зручні інструменти поступової міграції системи з монолітної архітектури до мікросервісної.</p> <h2 id="реалізація-хореографіі-саг"><a href="#реалізація-хореографіі-саг" class="header-anchor">#</a> Реалізація хореографії саг</h2> <p>Недоліком оркестрації саги для виявлення готовності ресурсів нашої системи є неможливість виявлення фактів дублювання сервісів, та стеження за їх станом. Це відбувається, бо черги RPC-викликів в даній реалізації є чергами завдань. Тобто, якщо запущено декілька екземплярів одного сервісу, лише один з них оброблює виклик.</p> <p>Для вирішення завдання стеження за всіма екземплярами сервісів треба скористатися шаблоном самореєстрації ресурсів, який передбачає що сам сервіс бере на себе обов'язки сповіщати про стан своєї готовності. Тоді події(доменні події), пов'язані
із зміною стану, в даному випадку, ресурсів будуть використовуватись споживачами черги таких подій для відповідної реакції на них.</p> <p>З точки зору завдання моніторингу стану ресурсів системи до таких подій треба віднести події появи нового екемпляра сервісу та подію сповіщення про готовність, яка періодично надсилається кожним мікросервісом.</p> <p>Нажаль, бібліотека на надає зручних способів створення продюсерів та споживачів повідомлень, тому необхідні засоби розробимо самостійно.</p> <p>Алгоритм створення продюсерів та споживачів повідомлень майже формальний і може параметризуватися. Проте кількість параметрів
та їх структура, заданих одночасно, створює незручності використання.</p> <p>Тому будемо розробляти класи з так званим ланцюжковим інтерфейсом, який дозволяє декомпозувати задання параметрів на декілька команд. Створення реальних об'єктів для реалізації зв'язку з брокером повідомлень буде відкладене в часі до моменту, коли без них реалізація методів буде неможлива(шаблон &quot;virtual proxy&quot;, &quot;lazy creating&quot;)</p> <p>Створимо файл <code>./utils/index.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;amqplib&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> extend <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> connection

<span class="token keyword">class</span> <span class="token class-name">Publisher</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connection <span class="token operator">=</span> connection
        <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token function">queue</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>

    <span class="token function">options</span><span class="token punctuation">(</span><span class="token parameter">opts</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">,</span> <span class="token punctuation">{</span>opts<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span> 
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">||</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_queue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_queue <span class="token operator">||</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">.</span>name<span class="token punctuation">,</span> 
                <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">.</span>options
            <span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">sendToQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queue<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connection <span class="token operator">=</span> connection
        <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token function">queue</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">prefetch</span><span class="token punctuation">(</span><span class="token parameter">prefetch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">.</span>prefetch <span class="token operator">=</span> prefetch
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>

    <span class="token function">options</span><span class="token punctuation">(</span><span class="token parameter">opts</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">,</span> <span class="token punctuation">{</span>opts<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span> 
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">consume</span><span class="token punctuation">(</span><span class="token parameter">handler<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_queue <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">.</span>name<span class="token punctuation">,</span> 
            <span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">.</span>options
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">.</span>prefetch<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">prefetch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queueOptions<span class="token punctuation">.</span>prefetch<span class="token punctuation">)</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queue<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">handler</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">ack</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>channel<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">domainEventProvider</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    connection <span class="token operator">=</span> connection <span class="token operator">||</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">publisher</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Publisher</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">consumer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>       

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> domainEventProvider

</code></pre></div><p>Модуль експортує функцію <code>domainEventProvider</code>, яка створює з'єднання <code>connection</code> з брокером повідомлень та надає функції для створення продюсерів та споживачів. Модуль використовує єдине з'єднання для створення всіх каналів, тому класи
<code>Publisher</code> та <code>Consumer</code> є локальними, а функції <code>publisher</code> та <code>consumer</code> повертають вже готові екземпляри
(конструктори цих класів захищені від використання за межами цього модуля).</p> <p>Клас <code>Publisher</code> реалізує функціональність продюсера та на рівні властивостей зберігає параметри та канал, який створюється в разі необхідності в методі <code>send</code>.</p> <p>Методи класу розроблені таким чином, щоб забезпечувати ланцюжковий інтерфейс, наприклад
<code>pub.queue(&quot;&lt;queue name&gt;&quot;).options(&lt;queue options&gt;).send(&lt;message&gt;, &lt;message options&gt;)</code>, це досягається тим, що кожен з методів повертає посилання на сам екземпляр.</p> <p>Аналогічно розроблений класс <code>Consumer</code>.</p> <p>Створимо файл <code>./services/deds.js</code>, який буде реалізовувати сервіс, що сам реєструється</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> MicroMQ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'micromq'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> instanceId <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> deds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> args <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Usage: node ./services/ms &quot;&lt;service name&gt;&quot;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> serviceName <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">deds</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>rabbit<span class="token punctuation">)</span>
    <span class="token keyword">const</span> heartbeat <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">publisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    heartbeat<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token string">&quot;service-heartbeat&quot;</span><span class="token punctuation">)</span>
    
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        heartbeat<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>event<span class="token operator">:</span><span class="token string">&quot;BEAT&quot;</span><span class="token punctuation">,</span> service<span class="token operator">:</span>serviceName<span class="token punctuation">,</span> instanceId<span class="token punctuation">,</span> at<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>     
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MicroMQ</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> serviceName<span class="token punctuation">,</span>
      rabbit<span class="token operator">:</span> config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>rabbit
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/s1/health'</span><span class="token punctuation">,</span><span class="token string">'/health'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>instanceId<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>  

    app<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">'get_health'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">meta<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>instanceId<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>  

    <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    heartbeat<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>event<span class="token operator">:</span><span class="token string">&quot;START&quot;</span><span class="token punctuation">,</span> service<span class="token operator">:</span>serviceName<span class="token punctuation">,</span> instanceId<span class="token punctuation">,</span> at<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serviceName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> instance </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>instanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> started</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>        
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>Щоб не створювати багато файлів, імітуючих роботу різниз сервісів, будемо визначати ім'я сервісу в командному рядку для запуску.</p> <p>Створюємо provider брокера повідомлень, потім продюсера heartbeat, якого налаштовуємо на використання черги service-heartbeat.
Перше повідомлення з  event:&quot;START&quot; посилаємо після успішного старту сервіса.</p> <p>Визначаємо періодичне(кожні 2с) відправлення повідомлення з event:&quot;BEAT&quot;. В кожному повідомленні передаємо унікальний ідентифікатор запещеного екземпляра сервіса та його ім'я.</p> <p>Вносимо зміни до файлу <code>./services/system-health.js</code></p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> MicroMQ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'micromq'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> instanceId <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> extend<span class="token punctuation">,</span> find <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> deds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;moment&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> instances <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">let</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">deds</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>rabbit<span class="token punctuation">)</span>
    <span class="token keyword">const</span> sub <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    sub<span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token string">&quot;service-heartbeat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prefetch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>event <span class="token operator">==</span> <span class="token string">&quot;START&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instances<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                instanceId<span class="token operator">:</span> message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>instanceId<span class="token punctuation">,</span>
                service<span class="token operator">:</span> message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">,</span>
                state<span class="token operator">:</span><span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
                startedAt<span class="token operator">:</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY-MM-DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                beatedAt<span class="token operator">:</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY-MM-DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                beatCount<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
                timeout<span class="token operator">:</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span> instances<span class="token punctuation">,</span> <span class="token parameter">inst</span> <span class="token operator">=&gt;</span> inst<span class="token punctuation">.</span>instanceId <span class="token operator">==</span> message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>instanceId<span class="token punctuation">)</span>
                    record<span class="token punctuation">.</span>state <span class="token operator">=</span><span class="token string">&quot;failed&quot;</span>
                    record<span class="token punctuation">.</span>stopedAt <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY-MM-DD HH:mm:ss&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>event <span class="token operator">==</span> <span class="token string">&quot;BEAT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span> instances<span class="token punctuation">,</span> <span class="token parameter">inst</span> <span class="token operator">=&gt;</span> inst<span class="token punctuation">.</span>instanceId <span class="token operator">==</span> message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>instanceId<span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    record<span class="token punctuation">.</span>beatedAt <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY-MM-DD HH:mm:ss&quot;</span><span class="token punctuation">)</span>
                    record<span class="token punctuation">.</span>beatCount<span class="token operator">++</span>
                    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
                    record<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span> instances<span class="token punctuation">,</span> <span class="token parameter">inst</span> <span class="token operator">=&gt;</span> inst<span class="token punctuation">.</span>instanceId <span class="token operator">==</span> message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>instanceId<span class="token punctuation">)</span>
                        record<span class="token punctuation">.</span>stopedAt <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY-MM-DD HH:mm:ss&quot;</span><span class="token punctuation">)</span>
                        record<span class="token punctuation">.</span>state <span class="token operator">=</span><span class="token string">&quot;failed&quot;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>   
        <span class="token punctuation">}</span>

        sub<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> noAck<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>        





    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MicroMQ</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'system-health'</span><span class="token punctuation">,</span>
      microservices<span class="token operator">:</span>config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>microservices<span class="token punctuation">,</span>
      rabbit<span class="token operator">:</span> config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>rabbit
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">getSystemHealth</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">rpcPattern</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>

        config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>microservices
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                
            <span class="token keyword">let</span> timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;failed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>service<span class="token operator">:</span>ms<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>    
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

            app<span class="token punctuation">.</span><span class="token function">ask</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> rpcPattern<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">resp</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;available&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resp<span class="token punctuation">,</span><span class="token punctuation">{</span>service<span class="token operator">:</span>ms<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;failed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>service<span class="token operator">:</span>ms<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>microservices<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">ms</span> <span class="token operator">=&gt;</span> 
        <span class="token function">find</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>service <span class="token operator">==</span> ms<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;failed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>service<span class="token operator">:</span>ms<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/health/act'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getSystemHealth</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        server<span class="token operator">:</span><span class="token punctuation">{</span>
            action<span class="token operator">:</span><span class="token string">&quot;get_health&quot;</span><span class="token punctuation">,</span>
            meta<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/health/req'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getSystemHealth</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> <span class="token string">&quot;/health&quot;</span><span class="token punctuation">,</span>
        params<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/sys/stat'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>instances<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">inst</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        service<span class="token operator">:</span> inst<span class="token punctuation">.</span>service<span class="token punctuation">,</span>
        state<span class="token operator">:</span> inst<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
        beatCount<span class="token operator">:</span>inst<span class="token punctuation">.</span>beatCount<span class="token punctuation">,</span>
        instanceId<span class="token operator">:</span> inst<span class="token punctuation">.</span>instanceId<span class="token punctuation">,</span>
        startedAt<span class="token operator">:</span>inst<span class="token punctuation">.</span>startedAt<span class="token punctuation">,</span>
        beatedAt<span class="token operator">:</span> inst<span class="token punctuation">.</span>beatedAt<span class="token punctuation">,</span>
        stopedAt<span class="token operator">:</span> inst<span class="token punctuation">.</span>stopedAt
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/health'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>instanceId<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>  

    app<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">'get_health'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">meta<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>instanceId<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>  

    app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">system-health instance </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>instanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> started</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>     
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>   

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>Створюємо споживача черги <code>service-heartbeat</code>, обробник якого слідкує за станом сервісів та вносить інформацію про них в
<code>instances</code>. Якщо інтервал часу між повідомленнями сервісу, який зареєструвався в черзі, перевищує час очікування, то ми
приймаємо рішення про неготовність сервісу.</p> <p>Звернення за маршрутом <code>/sys/stat</code> дозволяє отримати інформацію моніторингу готовності ресурсів.</p> <p>Внесемо зміни до конфігураційного файлу</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    server<span class="token operator">:</span><span class="token punctuation">{</span>
        port<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">8082</span><span class="token punctuation">,</span>
        staticPath<span class="token operator">:</span> <span class="token string">&quot;./assets&quot;</span><span class="token punctuation">,</span>
        routes<span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/health/act&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/health/req&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/sys/stat&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;system-health&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token string">&quot;/s1/health&quot;</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
                    <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;ms1&quot;</span><span class="token punctuation">)</span> 
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token string">&quot;/s2/health&quot;</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;ms2&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                path<span class="token operator">:</span> <span class="token string">&quot;/s3/health&quot;</span><span class="token punctuation">,</span>
                <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;ms3&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    apiGateway<span class="token operator">:</span><span class="token punctuation">{</span>
        microservices<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;ms1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ms2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ms3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;system-health&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        rabbit<span class="token operator">:</span> <span class="token punctuation">{</span>
            url<span class="token operator">:</span> <span class="token string">'&lt;your RabbitMQ url connection&gt;'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Додаємо делегування за маршрутом <code>/sys/stat</code>.</p> <p>Перезапустимо сервер та створимо декілька примірників сервісів, потім деякі зупинимо, для деяких запустимо копії.
Після цих маніпуляцій та звернення за адресою <a href="http://localhost:8080/sys/stat" target="_blank" rel="noopener noreferrer">http://localhost:8080/sys/stat<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> отримаємо</p> <div class="language-json extra-class"><pre class="language-json"><code>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ms1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;failed&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;beatCount&quot;</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;81649ab0-6ffd-4ad8-a74a-9a7d4c6c31a9&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;startedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-08-25 21:51:13&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;beatedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-08-25 21:52:02&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;stopedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-08-25 21:52:10&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ms1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;beatCount&quot;</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6f80f25f-3c11-4249-9fcd-a0001c76925d&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;startedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-08-25 21:51:21&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;beatedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-08-25 21:52:19&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ms2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;beatCount&quot;</span><span class="token operator">:</span> <span class="token number">27</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;335cff00-8e46-400a-ab54-85305bff2897&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;startedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-08-25 21:51:27&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;beatedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-08-25 21:52:18&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ms3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;beatCount&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token property">&quot;instanceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;e284077f-6cdd-4b7a-b324-775fa1a97641&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;startedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-08-25 21:52:10&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;beatedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-08-25 21:52:18&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</code></pre></div><p>Тепер ми бачимо стан кожного екземпляра сервісів, які реєструвалися в системі.</p> <p>Таким чином, хореографія саги визначення стану готовності ресурсів нашої системи, реалізована як реагування на доменні події (події старту та підтвердження готовності сервісів), дозволила слідкувати за станом кожного з екземплярів, чого не можна було зробити завдяки оркеструванню саги.</p> <h2 id="реалізація-вимикача-сервісів"><a href="#реалізація-вимикача-сервісів" class="header-anchor">#</a> Реалізація вимикача сервісів</h2> <p>Щоб обмежити тривалість операцій, ми можемо використовувати тайм-аути. Тайм-аути можуть запобігти операціям зависання та тримати систему у режимі реагування. Однак використання статичних, налаштованих тайм-аутів у спілкуванні мікросервісів є анти-шаблоном, оскільки ми знаходимось у високодинамічному середовищі, де практично неможливо придумати правильні обмеження часу, які добре працюють у кожному випадку.</p> <p>Замість того, щоб використовувати невеликі статичні таймаути, специфічні для транзакцій, ми можемо використовувати автоматичні вимикачі для вирішення помилок. Автоматичні вимикачі названі на честь електронного компонента реального світу, оскільки їх поведінка ідентична. Ви можете захистити ресурси та допомогти їм відновитися за допомогою автоматичних вимикачів. Вони можуть бути дуже корисними у розподіленій системі, де повторюваний збій може призвести до ефекту сніжної кулі та знищити всю систему.</p> <p>Вимикач розмикається, коли певний тип помилки виникає кілька разів за короткий період. Відключений автоматичний вимикач запобігає подальшим запитам - так само, як справжній, запобігає потоку електронів. Автоматичні вимикачі зазвичай закриваються через певний час, даючи достатньо місця для відновлення базових послуг.</p> <p>Відносно нашого завдання забезпечення готовності ресурсів системи та високого рівня доступності ми маємо певну затримку виконання запитів <a href="http://localhost:8080/health/ask" target="_blank" rel="noopener noreferrer">http://localhost:8080/health/ask<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> та <a href="http://localhost:8080/health/req" target="_blank" rel="noopener noreferrer">http://localhost:8080/health/req<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> тоді, коли деякий ресурс не готовий. Ця затримка визначається таймаутом очікування відповіді.</p> <p>В той самий час, сервіс <code>system-health</code> має інформацію про поточний стан всіх екземплярів ресурсів. Цю інформацію можна використати для того, щоб не опитувати взагалі неготові ресурси. Опитування начебто готових ресурсів нам необхідно з тої причини, що <code>system-health</code> фіксує стан екземплярів з невеликою затримкою.</p> <p>Таким чином, ми можемо реалізувати найпростіший вимикач, який використовує інформацію моніторингу.</p> <p>Для цього змінимо функцію <code>getSystemHealth</code></p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token function-variable function">getSystemHealth</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">rpcPattern</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>

        config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>microservices
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span> <span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token function">find</span><span class="token punctuation">(</span>instances<span class="token punctuation">,</span> <span class="token parameter">inst</span> <span class="token operator">=&gt;</span> inst<span class="token punctuation">.</span>service <span class="token operator">==</span> ms <span class="token operator">&amp;&amp;</span> inst<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                
            <span class="token comment">// let timeout = setTimeout(() =&gt; {</span>
            <span class="token comment">//  resolve(extend({state:&quot;failed&quot;}, {service:ms} ))    </span>
            <span class="token comment">// }, 2000)</span>

            app<span class="token punctuation">.</span><span class="token function">ask</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> rpcPattern<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">resp</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// clearTimeout(timeout)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;available&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resp<span class="token punctuation">,</span><span class="token punctuation">{</span>service<span class="token operator">:</span>ms<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// clearTimeout(timeout)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;failed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>service<span class="token operator">:</span>ms<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> config<span class="token punctuation">.</span>apiGateway<span class="token punctuation">.</span>microservices<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">ms</span> <span class="token operator">=&gt;</span> 
        <span class="token function">find</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>service <span class="token operator">==</span> ms<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>state<span class="token operator">:</span><span class="token string">&quot;failed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>service<span class="token operator">:</span>ms<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

</code></pre></div><p>Тепер ми опитуємо лише ті ресурси, що зафіксовані в списку config.apiGateway.microservices, та мають хоча б один екземпляр в стані готовності за даними моніторингу. Для тих, що не підпадають під ці умови, фіксується стан неготовності без опитування.</p> <p>Це дає можливість відмовитися від таймауту очікування відповіді( ці рядки закоментовано).</p> <p>Насправді реальні вимикачі набагато складніші.</p> <p>Не всі помилки повинні викликати автоматичний вимикач. Деякі автоматичні вимикачі також можуть мати напіввідкрите стан. У цьому стані служба надсилає перший запит для перевірки доступності системи, дозволяючи при цьому іншим запитам не працювати. Якщо цей перший запит вдається, він повертає автоматичний вимикач у відкритий стан і пропускає трафік. В іншому випадку він залишає його закритим.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/boldak/dis-edu/edit/master/docs/msa/14.msa.md" target="_blank" rel="noopener noreferrer">Ви можете покращити цю сторінку</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/25/2021, 11:36:11 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/eda/13.rabbitmq.html" class="prev">
        Реалізація обміну повідомленнями за допомогою RabbitMQ
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/docs/assets/js/app.6573e971.js" defer></script><script src="/docs/assets/js/2.43c74522.js" defer></script><script src="/docs/assets/js/33.43c31432.js" defer></script>
  </body>
</html>
